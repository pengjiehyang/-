<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>精美記帳 App v3.9.3</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 -960 960 960'><path fill='%234a90e2' d='M240-120q-33 0-56.5-23.5T160-200v-560q0-33 23.5-56.5T240-840h320l240 240v320q0 33-23.5 56.5T720-120H240Zm280-520v-200H240v560h480v-360H520ZM440-440h160v-60H440v60Zm0 120h160v-60H440v60Zm-200-320h400v-60H240v60Zm280-40Z'/></svg>">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- 全域與主題設定 --- */
        :root {
            --primary-color: #4a90e2;
            --primary-light: #eaf2fc;
            --secondary-color: #50e3c2;
            --accent-color: #f5a623;
            --text-color: #333;
            --text-light: #666;
            --bg-color: #f4f7f9;
            --bg-light: #ffffff;
            --border-color: #e0e6ed;
            --income-color: #2ecc71;
            --expense-color: #e74c3c;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --nav-height: 65px;
            --sidebar-width: 240px;
        }

        html[data-theme='dark'] {
            --primary-color: #58a6ff;
            --primary-light: #1f3a5a;
            --text-color: #c9d1d9;
            --text-light: #8b949e;
            --bg-color: #0d1117;
            --bg-light: #161b22;
            --border-color: #30363d;
            --income-color: #3fb950;
            --expense-color: #f85149;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        html { box-sizing: border-box; font-size: 16px; }
        *, *:before, *:after { box-sizing: inherit; margin: 0; padding: 0; }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- 主要佈局 (Mobile First) --- */
        #app-wrapper { display: flex; flex-direction: column; height: 100%; }
        #app-container { display: flex; flex-direction: column; height: 100%; width: 100%; max-width: 800px; margin: 0 auto; background-color: var(--bg-light); position: relative; transition: background-color 0.3s; }
        main { flex: 1; overflow-y: auto; padding: 1.5rem; padding-bottom: calc(var(--nav-height) + 1.5rem); }

        /* --- 頁面切換與動畫 --- */
        .page { display: none; animation: fadeIn 0.4s ease-in-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 底部導航欄 (Mobile) --- */
        #bottom-nav {
            display: flex; justify-content: space-around; align-items: center;
            background-color: var(--bg-light); box-shadow: 0 -2px 10px rgba(0,0,0,0.07);
            position: absolute; bottom: 0; left: 0; right: 0;
            height: var(--nav-height); z-index: 1000;
            border-top: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .nav-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            flex: 1; color: var(--text-light); cursor: pointer; transition: all 0.2s ease;
            border: none; background: none; padding: 8px 0; height: 100%;
        }
        .nav-btn .material-symbols-outlined { font-size: 24px; }
        .nav-btn-label { font-size: 12px; margin-top: 2px; }
        .nav-btn.active { color: var(--primary-color); }
        
        #nav-add-mobile {
            display: flex; align-items: center; justify-content: center;
            color: white; background-color: var(--primary-color); border-radius: 50%;
            width: 56px; height: 56px;
            position: relative; top: -15px;
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
            border: 4px solid var(--bg-light);
            cursor: pointer;
            flex-shrink: 0;
            transition: background-color 0.3s;
        }
        html[data-theme='dark'] #nav-add-mobile { box-shadow: 0 4px 12px rgba(88, 166, 255, 0.3); }
        #nav-add-mobile .material-symbols-outlined { font-size: 28px; }

        /* --- 通用元件 --- */
        .card { background-color: var(--bg-light); border-radius: 12px; box-shadow: var(--shadow); padding: 1.25rem; margin-bottom: 1.5rem; transition: background-color 0.3s, box-shadow 0.3s; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; }
        .btn .material-symbols-outlined { margin-right: 0.5rem; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-primary:disabled { background-color: #ccc; cursor: not-allowed; }
        html[data-theme='dark'] .btn-primary:disabled { background-color: #30363d; color: #8b949e; }
        .btn-secondary { background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background-color: var(--border-color); }
        .btn-danger { background-color: var(--expense-color); color: white; }
        .btn-danger:hover { opacity: 0.9; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.8rem; border-radius: 4px; }

        .page-header { font-size: 1.8rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--primary-color); display: flex; align-items: center; }
        .page-header .material-symbols-outlined { margin-right: 0.75rem; font-size: 2rem; }

        /* --- 表單樣式 --- */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-light); }
        .form-group input, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; background-color: var(--bg-light); color: var(--text-color); transition: border-color 0.2s, background-color 0.3s, box-shadow 0.2s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--primary-light); }
        .form-group .radio-group { display: flex; gap: 1rem; }
        .form-group .radio-group label { flex: 1; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s ease; }
        .form-group .radio-group input[type="radio"] { display: none; }
        .form-group .radio-group input[type="radio"]:checked + label { background-color: var(--primary-light); border-color: var(--primary-color); color: var(--primary-color); font-weight: 700; }
        
        /* --- 特定頁面手機樣式 --- */
        #page-dashboard .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .summary-card { padding: 1rem; border-radius: 8px; text-align: center; transition: background-color 0.3s; }
        .summary-card.income { background-color: #e9f9f0; color: var(--income-color); }
        .summary-card.expense { background-color: #fceeee; color: var(--expense-color); }
        .summary-card.balance { background-color: var(--primary-light); color: var(--primary-color); }
        html[data-theme='dark'] .summary-card.income { background-color: rgba(63, 185, 80, 0.15); }
        html[data-theme='dark'] .summary-card.expense { background-color: rgba(248, 81, 73, 0.15); }
        html[data-theme='dark'] .summary-card.balance { background-color: rgba(88, 166, 255, 0.15); }
        .summary-card h3 { font-size: 0.9rem; font-weight: 500; margin-bottom: 0.5rem; opacity: 0.8; }
        .summary-card p { font-size: 1.4rem; font-weight: 700; }
        .balance-card { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; text-align: center; }
        html[data-theme='dark'] .balance-card { background: linear-gradient(135deg, #1f3a5a, #164e42); }
        .balance-card h2 { font-weight: 500; }
        .balance-card p { font-size: 2.2rem; font-weight: 700; margin-top: 0.5rem; }
        .time-toggle { display: flex; justify-content: center; margin-bottom: 1.5rem; background-color: var(--bg-color); border-radius: 8px; padding: 4px; transition: background-color 0.3s; }
        .time-toggle-btn { flex: 1; padding: 0.5rem; border: none; background: none; cursor: pointer; border-radius: 6px; font-weight: 500; transition: all 0.2s ease; color: var(--text-light); display: inline-flex; align-items: center; justify-content: center; }
        .time-toggle-btn.active { background-color: var(--bg-light); color: var(--primary-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        html[data-theme='dark'] .time-toggle-btn.active { box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .transaction-filters { margin-bottom: 1rem; }
        .search-bar { position: relative; margin-bottom: 0.75rem; }
        .search-bar input:focus { box-shadow: 0 0 0 3px var(--primary-light); border-color: var(--primary-color); }
        .search-bar input { width: 100%; padding: 0.75rem; padding-left: 2.5rem; }
        .search-bar .material-symbols-outlined { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-light); }
        .category-filter-tags { display: flex; gap: 0.5rem; overflow-x: auto; padding-bottom: 0.5rem; }
        .category-filter-tags::-webkit-scrollbar { height: 4px; }
        .category-filter-tags::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 2px; }
        .filter-tag { padding: 0.25rem 0.75rem; border-radius: 16px; background-color: var(--bg-color); border: 1px solid var(--border-color); font-size: 0.9rem; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
        .filter-tag.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        
        .transaction-list-item { display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s, border-color 0.3s, opacity 0.2s; cursor: grab; }
        .transaction-list-item:last-child { border-bottom: none; }
        .transaction-list-item:hover { background-color: var(--primary-light); }
        .transaction-list-item.dragging { opacity: 0.5; background: var(--primary-light); }
        .transaction-list-item.drag-over { border-top: 2px solid var(--primary-color); }
        html[data-theme='dark'] .transaction-list-item:hover { background-color: #21262d; }
        .transaction-list-item mark { background-color: var(--accent-color); color: #fff; padding: 2px 4px; border-radius: 3px; }
        .transaction-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem; color: white; flex-shrink: 0; }
        .transaction-icon.income { background-color: var(--income-color); }
        .transaction-icon.expense { background-color: var(--expense-color); }
        .transaction-details { flex-grow: 1; }
        .transaction-details .description { font-weight: 500; font-size: 1.1rem; }
        .transaction-details .category-tag { display: inline-block; background-color: var(--bg-color); color: var(--text-light); padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; margin-top: 4px; transition: background-color 0.3s, color 0.3s; }
        .transaction-info { text-align: right; }
        .transaction-info .amount { font-weight: 700; font-size: 1.1rem; }
        .transaction-info .amount.income { color: var(--income-color); }
        .transaction-info .amount.expense { color: var(--expense-color); }
        .transaction-info .date { color: #888; font-size: 0.8rem; }
        
        .report-controls-container .report-controls { display: flex; flex-direction: column; gap: 1rem; }
        .monthly-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; text-align: center; }
        .stat-item h4 { font-size: 0.9rem; color: var(--text-light); font-weight: 500; }
        .stat-item p { font-size: 1.3rem; font-weight: 700; }
        .stat-item p.income { color: var(--income-color); }
        .stat-item p.expense { color: var(--expense-color); }
        .stat-item p.balance { color: var(--primary-color); }
        .chart-container { position: relative; height: 300px; width: 100%; margin-top: 1rem; }
        
        .budget-item { margin-bottom: 1rem; }
        .budget-item:last-child { margin-bottom: 0; }
        .progress-bar-container { width: 100%; background-color: var(--bg-color); border-radius: 4px; overflow: hidden; height: 8px; margin: 0.5rem 0; }
        .progress-bar { height: 100%; background-color: var(--primary-color); border-radius: 4px; transition: width 0.3s ease-in-out; }
        .progress-bar.warning { background-color: var(--accent-color); }
        .progress-bar.danger { background-color: var(--expense-color); }
        .budget-text { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-light); }

        #budget-form-container { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media (min-width: 600px) { #budget-form-container { grid-template-columns: 1fr 1fr; } }
        .budget-card { border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; }
        .budget-card-header { font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem; }
        .budget-input-area { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
        .budget-input-area span { font-size: 1.2rem; color: var(--text-light); }
        .budget-input { font-size: 1.2rem; font-weight: 500; border: none; border-bottom: 2px solid var(--border-color); border-radius: 0; padding: 0.25rem 0; width:100%; background:transparent; }
        .budget-input:focus { box-shadow: none; border-bottom-color: var(--primary-color); }
        .budget-summary-text { display: flex; justify-content: space-between; font-size: 0.9rem; margin-top: 0.5rem; }
        .budget-remaining.negative { color: var(--expense-color); font-weight: 700; }
        .management-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }

        .modal { position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--bg-light); margin: auto; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; animation: slideIn 0.3s ease-out; transition: background-color 0.3s; }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h2 { font-size: 1.5rem; color: var(--primary-color); }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        html[data-theme='dark'] .close-btn { color: var(--text-light); }
        .modal-actions { display: flex; gap: 1rem; margin-top: 1rem; }
        .modal-actions .btn { flex: 1; }
        
        /* Animation Modal Styles */
        #animation-modal .modal-content { max-width: 600px; }
        .animation-display-area { min-height: 120px; border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; display: flex; align-items: center; justify-content: center; text-align: center; }
        .animation-display-area .tx-item { animation: anim-tx-fade-in 0.5s ease; }
        @keyframes anim-tx-fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animation-display-area .tx-date { font-size: 0.9rem; color: var(--text-light); }
        .animation-display-area .tx-desc { font-size: 1.2rem; font-weight: 500; margin: 0.25rem 0; }
        .animation-display-area .tx-amount.income { color: var(--income-color); font-weight: 700; font-size: 1.5rem; }
        .animation-display-area .tx-amount.expense { color: var(--expense-color); font-weight: 700; font-size: 1.5rem; }
        .animation-balance-area { margin-top: 1rem; text-align: center; }
        .animation-balance-area h4 { color: var(--text-light); font-weight: 500; }
        .animation-balance-area p { font-size: 2rem; font-weight: 700; color: var(--primary-color); }
        .animation-progress-bar { height: 6px; background-color: var(--primary-color); width: 0%; border-radius: 3px; transition: width 0.3s ease; }
        .animation-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; gap: 1rem; }
        .animation-controls .speed-control { display: flex; align-items: center; gap: 0.5rem; }

        .no-data { text-align: center; padding: 3rem 1rem; color: #888; }
        .no-data .material-symbols-outlined { font-size: 4rem; margin-bottom: 1rem; }

        #nav-add-desktop { display: none; }
        .desktop-only-nav-item { display: none; }
        
        @media (min-width: 801px) {
            body { display: flex; align-items: center; justify-content: center; padding: 2rem; }
            #app-wrapper { flex-direction: row; height: 100%; max-height: 90vh; width: 100%; max-width: 1200px; background-color: var(--bg-light); box-shadow: 0 8px 32px rgba(0,0,0,0.1); border-radius: 16px; overflow: hidden; }
            #app-container { flex-direction: row; max-width: none; }
            #bottom-nav { position: static; flex-direction: column; justify-content: flex-start; align-items: stretch; height: 100%; width: var(--sidebar-width); border-top: none; border-right: 1px solid var(--border-color); padding: 1.5rem 1rem; gap: 0.5rem; overflow-y: auto; }
            .nav-btn { flex-direction: row; justify-content: flex-start; padding: 0.75rem 1rem; border-radius: 8px; flex: 0; }
            .nav-btn .material-symbols-outlined { margin-right: 1rem; }
            .nav-btn-label { font-size: 1rem; }
            .nav-btn.active { background-color: var(--primary-light); }
            #nav-add-mobile { display: none; }
            #nav-add-desktop { display: flex; width: 100%; margin-bottom: 1rem; }
            .desktop-only-nav-item { display: flex; }
            #theme-toggle-desktop { flex-direction: column; align-items: stretch; padding: 0.75rem 0.5rem; margin-top: auto; }
            #theme-toggle-desktop .nav-btn-label { color: var(--text-light); font-size: 0.9rem; font-weight: 500; margin-bottom: 0.5rem; text-align: left; padding: 0 0.5rem; }
            #theme-toggle-desktop .time-toggle { margin-bottom: 0; }
            .mobile-only-card { display: none; }
            .mobile-only-back-btn { display: none; }
            main { flex: 1; padding: 2rem; padding-bottom: 2rem; }
            #page-dashboard .dashboard-grid { display: grid; grid-template-columns: 320px 1fr; gap: 2rem; align-items: flex-start; }
            #page-reports .reports-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: flex-start; }
            .report-controls-container .report-controls { flex-direction: row; }
        }
    </style>
</head>
<body>

    <div id="app-wrapper">
        <nav id="bottom-nav">
            <button id="nav-add-desktop" class="btn btn-primary"><span class="material-symbols-outlined">add</span>新增交易</button>
            <button class="nav-btn active" data-page="dashboard"><span class="material-symbols-outlined">dashboard</span><span class="nav-btn-label">儀表板</span></button>
            <button class="nav-btn" data-page="transactions"><span class="material-symbols-outlined">receipt_long</span><span class="nav-btn-label">交易</span></button>
            <button id="nav-add-mobile"><span class="material-symbols-outlined">add</span></button> 
            <button class="nav-btn" data-page="reports"><span class="material-symbols-outlined">analytics</span><span class="nav-btn-label">報表</span></button>
            
            <button class="nav-btn desktop-only-nav-item" data-page="financial-management"><span class="material-symbols-outlined">account_balance</span><span class="nav-btn-label">財務管理</span></button>
            <button class="nav-btn desktop-only-nav-item" data-page="categories"><span class="material-symbols-outlined">sell</span><span class="nav-btn-label">類別管理</span></button>
            <button class="nav-btn desktop-only-nav-item" data-page="calculator"><span class="material-symbols-outlined">calculate</span><span class="nav-btn-label">理財計算機</span></button>
            
            <button class="nav-btn" data-page="others"><span class="material-symbols-outlined">more_horiz</span><span class="nav-btn-label">其他</span></button>

            <div id="theme-toggle-desktop" class="desktop-only-nav-item">
                <span class="nav-btn-label">外觀設定</span>
                <div class="time-toggle theme-toggle">
                    <button class="time-toggle-btn" data-theme-value="light"><span class="material-symbols-outlined" style="margin-right:0.5rem; font-size: 1.2rem;">light_mode</span></button>
                    <button class="time-toggle-btn" data-theme-value="dark"><span class="material-symbols-outlined" style="margin-right:0.5rem; font-size: 1.2rem;">dark_mode</span></button>
                </div>
            </div>
        </nav>

        <div id="app-container">
            <main>
                <!-- 儀表板 Page -->
                <div id="page-dashboard" class="page active">
                    <div class="page-header"><span class="material-symbols-outlined">dashboard</span>儀表板</div>
                    <div class="dashboard-grid">
                        <div class="dashboard-col-1">
                            <div class="card balance-card"><h2>目前餘額</h2><p id="dashboard-balance">$0</p></div>
                            <div id="salary-claim-container"></div>
                            <div class="time-toggle"><button class="time-toggle-btn active" data-period="day">日</button><button class="time-toggle-btn" data-period="month">月</button><button class="time-toggle-btn" data-period="year">年</button></div>
                            <div class="summary-grid">
                                <div class="summary-card income"><h3>總收入</h3><p id="dashboard-income">$0</p></div>
                                <div class="summary-card expense"><h3>總支出</h3><p id="dashboard-expense">$0</p></div>
                                <div class="summary-card balance"><h3>淨收支</h3><p id="dashboard-net-income">$0</p></div>
                            </div>
                            <div id="budget-tracking-container" class="card"></div>
                        </div>
                        <div class="dashboard-col-2">
                             <div class="card" style="height: 100%;"><h3>收支趨勢</h3><div class="chart-container" style="height: 90%;"><canvas id="dashboard-chart"></canvas></div></div>
                        </div>
                    </div>
                </div>

                <!-- 交易列表 Page -->
                <div id="page-transactions" class="page">
                    <div class="page-header"><span class="material-symbols-outlined">receipt_long</span>交易紀錄</div>
                    <div class="transaction-filters"><div class="search-bar"><span class="material-symbols-outlined">search</span><input type="text" id="search-input" placeholder="搜尋備註或類別..."></div><div class="category-filter-tags" id="category-filter-container"></div></div>
                    <div id="transaction-list-container"></div>
                </div>

                <!-- 報表 Page -->
                <div id="page-reports" class="page">
                    <div class="page-header"><span class="material-symbols-outlined">analytics</span>財務報表</div>
                    <div class="time-toggle" id="report-tabs"><button class="time-toggle-btn active" data-report-type="monthly">每月</button><button class="time-toggle-btn" data-report-type="daily">每日</button><button class="time-toggle-btn" data-report-type="yearly">每年</button></div>
                    <div class="card report-controls-container">
                        <h3>選擇範圍</h3>
                        <div id="daily-controls" style="display: none;"><div class="report-controls"><div class="form-group"><label for="report-date-select">日期</label><input type="date" id="report-date-select"></div></div></div>
                        <div id="monthly-controls"><div class="report-controls"><div class="form-group"><label for="report-month-year-select">年份</label><select id="report-month-year-select"></select></div><div class="form-group"><label for="report-month-select">月份</label><select id="report-month-select"></select></div></div></div>
                        <div id="yearly-controls" style="display: none;"><div class="report-controls"><div class="form-group"><label for="report-year-select">年份</label><select id="report-year-select"></select></div></div></div>
                    </div>
                    <div class="reports-grid">
                        <div class="card"><div id="report-stats-results" class="monthly-stats-grid"></div></div>
                        <div class="card"><h3 id="category-pie-chart-title">支出分類</h3><div class="chart-container"><canvas id="category-pie-chart"></canvas></div></div>
                    </div>
                </div>
                
                <!-- 其他 Page -->
                <div id="page-others" class="page">
                    <div class="page-header"><span class="material-symbols-outlined">more_horiz</span>其他</div>
                    <div class="management-grid">
                         <div class="card mobile-only-card">
                            <h3><span class="material-symbols-outlined" style="vertical-align: bottom; margin-right: 0.5rem;">contrast</span>外觀設定</h3>
                            <p style="margin-bottom: 1rem; color: var(--text-light);">選擇您喜歡的應用程式外觀。</p>
                            <div class="time-toggle theme-toggle">
                                <button class="time-toggle-btn" data-theme-value="light"><span class="material-symbols-outlined" style="margin-right:0.5rem; font-size: 1.2rem;">light_mode</span>淺色</button>
                                <button class="time-toggle-btn" data-theme-value="dark"><span class="material-symbols-outlined" style="margin-right:0.5rem; font-size: 1.2rem;">dark_mode</span>深色</button>
                            </div>
                        </div>
                        <div class="card mobile-only-card">
                            <h3><span class="material-symbols-outlined" style="vertical-align: bottom; margin-right: 0.5rem;">account_balance</span>財務管理</h3>
                            <p style="margin-bottom: 1rem; color: var(--text-light);">管理您的薪水、預算與每月盈餘。</p>
                            <button id="go-to-financial-management-btn" class="btn btn-secondary" style="width: 100%;">前往財務管理</button>
                        </div>
                        <div class="card mobile-only-card">
                            <h3><span class="material-symbols-outlined" style="vertical-align: bottom; margin-right: 0.5rem;">calculate</span>理財計算機</h3>
                            <p style="margin-bottom: 1rem; color: var(--text-light);">進行複利、貸款、投資報酬率等計算。</p>
                            <button id="go-to-calculator-btn" class="btn btn-secondary" style="width: 100%;">前往計算機</button>
                        </div>
                        <div class="card mobile-only-card">
                            <h3><span class="material-symbols-outlined" style="vertical-align: bottom; margin-right: 0.5rem;">sell</span>類別管理</h3>
                            <p style="margin-bottom: 1rem; color: var(--text-light);">管理您的收入與支出類別。</p>
                            <button id="go-to-categories-btn" class="btn btn-secondary" style="width: 100%;">前往類別管理</button>
                        </div>
                        <div class="card">
                            <h3><span class="material-symbols-outlined" style="vertical-align: bottom; margin-right: 0.5rem;">movie</span>本月動畫</h3>
                            <p style="margin-bottom: 1rem; color: var(--text-light);">以動畫方式回顧您本月的消費歷程。</p>
                            <button id="play-animation-btn" class="btn btn-secondary" style="width: 100%;">播放本月動畫</button>
                        </div>
                        <div class="card">
                            <h3><span class="material-symbols-outlined" style="vertical-align: bottom; margin-right: 0.5rem;">database</span>資料管理</h3>
                            <p style="margin-bottom: 1rem; color: var(--text-light);">匯出、匯入或清除您的記帳資料。</p>
                            <button id="go-to-data-btn" class="btn btn-secondary" style="width: 100%;">前往資料管理</button>
                        </div>
                        <div class="card">
                            <h3><span class="material-symbols-outlined" style="vertical-align: bottom; margin-right: 0.5rem;">info</span>關於本程式</h3>
                            <p style="margin-bottom: 1rem; color: var(--text-light);">查看應用程式的相關資訊。</p>
                            <button id="go-to-about-btn" class="btn btn-secondary" style="width: 100%;">關於</button>
                        </div>
                    </div>
                </div>

                <!-- 子頁面 (隱藏) -->
                <div id="page-financial-management" class="page"></div>
                <div id="page-categories" class="page"></div>
                <div id="page-data" class="page"></div>
                <div id="page-about" class="page"></div>
                <div id="page-calculator" class="page"></div>
                <div id="page-budgets" class="page"></div>
                <div id="page-salary" class="page"></div>
                <div id="page-surplus" class="page"></div>
            </main>
        </div>
    </div>

    <!-- Modals (彈出視窗) -->
    <div id="transaction-modal" class="modal"></div>
    <div id="category-modal" class="modal"></div>
    <div id="animation-modal" class="modal"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- 全域變數和資料結構 ---
    const THEME_KEY = 'accountingAppTheme_v3';
    let data = {
        transactions: [],
        categories: [
            { id: 1, name: '餐飲' }, { id: 2, name: '交通' }, { id: 3, name: '購物' },
            { id: 4, name: '娛樂' }, { id: 5, name: '薪資' }, { id: 6, name: '投資' },
        ],
        budgets: {},
        salary: { amount: 0, categoryId: null, showClaimButton: false, lastClaimedMonth: null }
    };
    
    let chartInstances = {};
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);
    let draggedItem = null;
    
    // Animation state
    let animationInterval = null;
    let animationIndex = 0;
    let animationTransactions = [];
    let animationSpeed = 1500;
    let animationRunningBalance = 0;

    // --- 初始化 ---
    function init() {
        loadTheme();
        loadData();
        renderSubPages();
        setupEventListeners();
        navigateTo('dashboard');
    }

    // --- 主題處理 ---
    function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem(THEME_KEY, theme);
        $$('.theme-toggle').forEach(container => {
            const lightBtn = container.querySelector(`[data-theme-value="light"]`);
            const darkBtn = container.querySelector(`[data-theme-value="dark"]`);
            if (lightBtn) lightBtn.classList.toggle('active', theme === 'light');
            if (darkBtn) darkBtn.classList.toggle('active', theme === 'dark');
        });

        if ($('#page-dashboard').classList.contains('active')) renderDashboard();
        if ($('#page-reports').classList.contains('active')) renderReportData();
    }

    function loadTheme() {
        const savedTheme = localStorage.getItem(THEME_KEY);
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));
    }

    // --- 資料處理 ---
    function saveData() { localStorage.setItem('accountingAppData', JSON.stringify(data)); }
    function loadData() {
        const savedData = localStorage.getItem('accountingAppData');
        if (savedData) data = JSON.parse(savedData);
        if (!data.categories) data.categories = [];
        if (!data.transactions) data.transactions = [];
        if (!data.budgets) data.budgets = {};
        
        if (!data.salary) {
            data.salary = { amount: 0, categoryId: null, showClaimButton: false, lastClaimedMonth: null };
        }
        if (typeof data.salary.showClaimButton === 'undefined') {
            data.salary.showClaimButton = false;
            data.salary.lastClaimedMonth = data.salary.lastAutoAddMonth || null;
            delete data.salary.autoAdd;
            delete data.salary.autoAddDay;
            delete data.salary.lastAutoAddMonth;
        }

        if (data.transactions.length > 0 && typeof data.transactions[0].order === 'undefined') {
            reindexOrder();
            saveData();
        }
    }
    
    function reindexOrder() {
        data.transactions.forEach((t, index) => { t.order = index; });
    }

    // --- 導航 ---
    function navigateTo(pageId, isSubPage = false) {
        $$('.page').forEach(p => p.classList.remove('active'));
        $(`#page-${pageId}`).classList.add('active');
        
        $$('.nav-btn').forEach(b => b.classList.remove('active'));
        const navButton = $(`button[data-page="${pageId}"]`);
        if (navButton) navButton.classList.add('active');

        const isDesktop = window.innerWidth > 800;
        if (isDesktop) {
            $('#app-wrapper').style.flexDirection = 'row';
            $('#bottom-nav').style.display = 'flex';
        } else {
             $('#bottom-nav').style.display = isSubPage ? 'none' : 'flex';
        }
        
        switch (pageId) {
            case 'dashboard': updateAllDashboard(); break;
            case 'transactions': updateAllTransactions(); break;
            case 'categories': renderCategories(); break;
            case 'reports': updateAllReports(); break;
            case 'budgets': renderBudgets(); break;
            case 'salary': renderSalaryManagement(); break;
            case 'surplus': renderSurplusManagement(); break;
        }
    }
    
    // --- 渲染邏輯 ---
    function updateAll() {
        const activePageElement = $('.page.active');
        if (activePageElement) {
            const activePageId = activePageElement.id.replace('page-', '');
            const mainPages = ['dashboard', 'transactions', 'reports', 'financial-management', 'others'];
            const desktopNavPages = ['categories', 'calculator'];
            const isSubPage = !mainPages.includes(activePageId) && !desktopNavPages.includes(activePageId);
            navigateTo(activePageId, isSubPage);
        } else {
            navigateTo('dashboard');
        }
    }

    function renderSubPages() {
        $('#page-financial-management').innerHTML = `<button class="btn btn-secondary back-btn mobile-only-back-btn" data-target="others"><span class="material-symbols-outlined">arrow_back</span>返回</button><div class="page-header"><span class="material-symbols-outlined">account_balance</span>財務管理</div><div class="management-grid"><div class="card"><h3><span class="material-symbols-outlined" style="vertical-align: bottom; margin-right: 0.5rem;">savings</span>預算管理</h3><p style="margin-bottom: 1rem; color: var(--text-light);">設定並追蹤您的每月類別預算。</p><button class="btn btn-secondary" data-target-page="budgets" style="width: 100%;">前往預算管理</button></div><div class="card"><h3><span class="material-symbols-outlined" style="vertical-align: bottom; margin-right: 0.5rem;">payments</span>薪水管理</h3><p style="margin-bottom: 1rem; color: var(--text-light);">設定您的主要月收入來源。</p><button class="btn btn-secondary" data-target-page="salary" style="width: 100%;">前往薪水管理</button></div><div class="card"><h3><span class="material-symbols-outlined" style="vertical-align: bottom; margin-right: 0.5rem;">trending_up</span>盈餘管理</h3><p style="margin-bottom: 1rem; color: var(--text-light);">查看您的每月財務盈餘或赤字。</p><button class="btn btn-secondary" data-target-page="surplus" style="width: 100%;">前往盈餘管理</button></div></div>`;
        $('#page-categories').innerHTML = `<button class="btn btn-secondary back-btn mobile-only-back-btn" data-target="others"><span class="material-symbols-outlined">arrow_back</span>返回</button><div class="page-header"><span class="material-symbols-outlined">sell</span>類別管理</div><div class="card"><button id="add-category-btn" class="btn btn-primary" style="width: 100%;"><span class="material-symbols-outlined">add_circle</span>新增類別</button></div><div class="card"><div id="category-list"></div></div>`;
        $('#page-data').innerHTML = `<button class="btn btn-secondary back-btn" data-target="others"><span class="material-symbols-outlined">arrow_back</span>返回</button><div class="page-header"><span class="material-symbols-outlined">database</span>資料管理</div><div class="card"><h3>匯出資料</h3><p style="margin-bottom: 1rem; color: var(--text-light);">將您的所有資料匯出成 JSON 檔備份。</p><button id="export-data-btn" class="btn btn-primary"><span class="material-symbols-outlined">file_download</span>匯出 JSON</button></div><div class="card"><h3>匯入資料</h3><p style="margin-bottom: 1rem; color: var(--text-light);">從 JSON 檔匯入資料。注意：這將覆蓋您目前所有資料！</p><button id="import-data-btn" class="btn btn-secondary"><span class="material-symbols-outlined">file_upload</span>匯入 JSON</button><input type="file" id="import-file-input" accept=".json" style="display: none;"></div><div class="card"><h3>清除所有資料</h3><p style="margin-bottom: 1rem; color: var(--text-light);">永久刪除所有交易和類別，無法復原。</p><button id="clear-data-btn" class="btn btn-danger"><span class="material-symbols-outlined">delete_forever</span>清除資料</button></div>`;
        $('#page-about').innerHTML = `<button class="btn btn-secondary back-btn" data-target="others"><span class="material-symbols-outlined">arrow_back</span>返回</button><div class="page-header"><span class="material-symbols-outlined">info</span>關於</div><div class="card"><h2>精美記帳 App v3.9.3</h2><p>一個功能齊全、美觀高效的單一 HTML 檔案記帳應用程式。</p><br><h4>核心特色：</h4><ul><li><strong>無需安裝</strong>：單一 HTML 檔案，下載即可使用。</li><li><strong>本地儲存</strong>：所有資料安全地儲存在您的瀏覽器中。</li><li><strong>響應式設計</strong>：完美適配手機、平板和桌面電腦，提供專屬優化介面。</li><li><strong>財務管理</strong>：整合預算、薪水、盈餘管理工具。</li><li><strong>主題模式</strong>：支援淺色與深色模式，並記憶您的選擇。</li><li><strong>資料自由</strong>：隨時可以匯出和匯入您的資料。</li></ul></div>`;
        $('#page-calculator').innerHTML = `<button class="btn btn-secondary back-btn mobile-only-back-btn" data-target="others"><span class="material-symbols-outlined">arrow_back</span>返回</button><div class="page-header"><span class="material-symbols-outlined">calculate</span>理財計算機</div><div class="time-toggle" id="calculator-tabs" style="margin-bottom: 1.5rem;"><button class="time-toggle-btn active" data-calculator="compound">複利計算</button><button class="time-toggle-btn" data-calculator="loan">貸款月付金</button><button class="time-toggle-btn" data-calculator="roi">投資報酬率 (ROI)</button></div><div id="calculator-content"><div class="calculator-pane active" data-pane="compound"><div class="card"><h3>複利計算</h3><form id="compound-interest-form"><div class="form-group"><label for="ci-principal">初始本金 ($)</label><input type="number" id="ci-principal" value="10000" required></div><div class="form-group"><label for="ci-rate">年利率 (%)</label><input type="number" id="ci-rate" value="5" step="0.1" required></div><div class="form-group"><label for="ci-years">投資年期 (年)</label><input type="number" id="ci-years" value="10" required></div><div class="form-group"><label for="ci-compound-freq">複利計算頻率</label><select id="ci-compound-freq"><option value="1">每年</option><option value="2">每半年</option><option value="4">每季</option><option value="12" selected>每月</option></select></div><button type="submit" class="btn btn-primary" style="width:100%;">計算</button></form><div id="ci-result" style="margin-top: 1.5rem; display: none;"><h4>計算結果</h4><p>未來總值：<strong id="ci-future-value" style="font-size: 1.5rem; color: var(--primary-color);"></strong></p><p>總利息：<strong id="ci-total-interest"></strong></p></div></div></div><div class="calculator-pane" data-pane="loan" style="display:none;"><div class="card"><h3>貸款月付金計算</h3><form id="loan-form"><div class="form-group"><label for="loan-amount">貸款總額 ($)</label><input type="number" id="loan-amount" value="500000" required></div><div class="form-group"><label for="loan-rate">年利率 (%)</label><input type="number" id="loan-rate" value="3" step="0.01" required></div><div class="form-group"><label for="loan-term">貸款期數 (年)</label><input type="number" id="loan-term" value="30" required></div><button type="submit" class="btn btn-primary" style="width:100%;">計算</button></form><div id="loan-result" style="margin-top: 1.5rem; display: none;"><h4>計算結果</h4><p>每月應付金額：<strong id="loan-monthly-payment" style="font-size: 1.5rem; color: var(--primary-color);"></strong></p><p>總支付金額：<strong id="loan-total-payment"></strong></p><p>總利息支出：<strong id="loan-total-interest"></strong></p></div></div></div><div class="calculator-pane" data-pane="roi" style="display:none;"><div class="card"><h3>投資報酬率 (ROI) 計算</h3><form id="roi-form"><div class="form-group"><label for="roi-initial">初始投資金額 ($)</label><input type="number" id="roi-initial" value="10000" required></div><div class="form-group"><label for="roi-final">最終價值 ($)</label><input type="number" id="roi-final" value="15000" required></div><button type="submit" class="btn btn-primary" style="width:100%;">計算</button></form><div id="roi-result" style="margin-top: 1.5rem; display: none;"><h4>計算結果</h4><p>投資報酬率 (ROI)：<strong id="roi-percentage" style="font-size: 1.5rem; color: var(--primary-color);"></strong></p><p>淨利潤：<strong id="roi-net-profit"></strong></p></div></div></div></div>`;
        $('#page-budgets').innerHTML = `<button class="btn btn-secondary back-btn" data-target="financial-management"><span class="material-symbols-outlined">arrow_back</span>返回財務管理</button><div class="page-header"><span class="material-symbols-outlined">savings</span>預算管理</div><div class="card"><div id="budget-form-container"></div><button id="save-budgets-btn" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">儲存預算</button></div>`;
        $('#page-salary').innerHTML = `<button class="btn btn-secondary back-btn" data-target="financial-management"><span class="material-symbols-outlined">arrow_back</span>返回財務管理</button><div class="page-header"><span class="material-symbols-outlined">payments</span>薪水管理</div><div class="card"><div class="form-group"><label for="salary-amount">每月主要薪資金額</label><div class="budget-input-area" style="margin-bottom:0"><span>$</span><input type="number" id="salary-amount" class="budget-input" placeholder="例如: 50000"></div></div><div class="form-group" style="margin-top:2rem"><label for="salary-category">選擇對應的薪資類別</label><select id="salary-category"></select></div><hr style="border:none; border-top: 1px solid var(--border-color); margin: 1.5rem 0;"><div class="form-group"><label>手動領薪功能</label><div class="radio-group"><input type="radio" id="claim-salary-off" name="claim-salary-toggle" value="off" checked><label for="claim-salary-off">關閉</label><input type="radio" id="claim-salary-on" name="claim-salary-toggle" value="on"><label for="claim-salary-on">啟用</label></div><p style="font-size: 0.8rem; color: var(--text-light); margin-top: 0.5rem;">啟用後，儀表板將顯示一個按鈕，讓您手動領取當月薪資。</p></div><button id="save-salary-btn" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">儲存設定</button></div>`;
        $('#page-surplus').innerHTML = `<button class="btn btn-secondary back-btn" data-target="financial-management"><span class="material-symbols-outlined">arrow_back</span>返回財務管理</button><div class="page-header"><span class="material-symbols-outlined">trending_up</span>本月盈餘分析</div><div class="card text-center" style="text-align:center;"><h3 style="color:var(--text-light)">本月淨盈餘</h3><p id="surplus-total" style="font-size: 2.5rem; font-weight: 700; margin: 0.5rem 0;"></p></div><div class="card"><div id="surplus-breakdown"></div></div>`;
        $('#transaction-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h2 id="transaction-modal-title">新增交易</h2><span class="close-btn">×</span></div><form id="transaction-form"><input type="hidden" id="transaction-id"><div class="form-group"><div class="radio-group"><input type="radio" id="type-expense" name="type" value="expense" checked><label for="type-expense">支出</label><input type="radio" id="type-income" name="type" value="income"><label for="type-income">收入</label></div></div><div class="form-group"><label for="amount">金額</label><input type="number" id="amount" placeholder="0" required min="0" step="any"></div><div class="form-group"><label for="category">類別</label><select id="category" required></select></div><div class="form-group"><label for="date">日期</label><input type="date" id="date" required></div><div class="form-group"><label for="description">備註 (選填)</label><input type="text" id="description" placeholder="例如：晚餐、薪水"></div><div class="modal-actions"><button type="button" id="delete-transaction-btn" class="btn btn-danger" style="display:none;"><span class="material-symbols-outlined">delete</span>刪除</button><button type="submit" class="btn btn-primary"><span class="material-symbols-outlined">save</span>儲存</button></div></form></div>`;
        $('#category-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h2 id="category-modal-title">新增類別</h2><span class="close-btn">×</span></div><form id="category-form"><input type="hidden" id="category-id"><div class="form-group"><label for="category-name">類別名稱</label><input type="text" id="category-name" placeholder="例如：餐飲、交通" required></div><button type="submit" class="btn btn-primary" style="width:100%;">儲存</button></form></div>`;
        $('#animation-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h2 id="animation-modal-title">本月交易動畫</h2><span class="close-btn" id="animation-close-btn">×</span></div><div class="animation-display-area"><div id="animation-tx-item-container"></div></div><div class="animation-balance-area"><h4>運行餘額</h4><p id="animation-running-balance">$0</p></div><div class="progress-bar-container" style="margin-top:1rem; height:6px;"><div id="animation-progress-bar" class="animation-progress-bar"></div></div><div class="animation-controls"><button id="animation-play-pause-btn" class="btn btn-primary"><span class="material-symbols-outlined">play_arrow</span>播放</button><div class="speed-control"><label for="animation-speed-select" style="font-size:0.9rem">速度:</label><select id="animation-speed-select" class="btn-sm"><option value="2000">慢</option><option value="1500" selected>中</option><option value="800">快</option></select></div></div></div>`;
    }

    function updateAllDashboard() { renderDashboard(); }
    function updateAllTransactions() { renderCategoryFilters(); renderTransactions(); }
    function updateAllReports() { populateReportSelectors(); renderReportData(); }
    
    function renderDashboard() {
        renderDashboardSalaryClaim();
        const period = $('#page-dashboard .time-toggle-btn.active').dataset.period;
        const now = new Date();
        let filteredTransactions;
        if (period === 'day') { filteredTransactions = data.transactions.filter(t => t.date === now.toISOString().split('T')[0]); } 
        else if (period === 'month') { filteredTransactions = data.transactions.filter(t => t.date.startsWith(now.toISOString().slice(0, 7))); } 
        else { filteredTransactions = data.transactions.filter(t => new Date(t.date).getFullYear() === now.getFullYear()); }
        
        const income = filteredTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
        const expense = filteredTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
        const netIncome = income - expense;
        const totalBalance = data.transactions.reduce((bal, t) => t.type === 'income' ? bal + t.amount : bal - t.amount, 0);
        
        $('#dashboard-income').textContent = formatCurrency(income); 
        $('#dashboard-expense').textContent = formatCurrency(expense);
        $('#dashboard-balance').textContent = formatCurrency(totalBalance);
        
        const netIncomeEl = $('#dashboard-net-income');
        netIncomeEl.textContent = formatCurrency(netIncome);
        const style = getComputedStyle(document.documentElement);
        if (netIncome === 0) {
            netIncomeEl.style.color = style.getPropertyValue('--text-light');
        } else {
            netIncomeEl.style.color = netIncome < 0 ? style.getPropertyValue('--expense-color') : style.getPropertyValue('--income-color');
        }
        
        renderDashboardBudgetTracking();
        renderDashboardChart(period);
    }
    
    function highlightText(text, term) {
        if (!term || !text) return text || '';
        const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`(${escapedTerm})`, 'gi');
        return text.replace(regex, `<mark>$1</mark>`);
    }

    function renderTransactions() {
        const container = $('#transaction-list-container');
        container.innerHTML = '';
        const searchTerm = $('#search-input').value.toLowerCase();
        const activeCategoryTag = $('#category-filter-container .filter-tag.active');
        const categoryId = activeCategoryTag ? activeCategoryTag.dataset.id : null;

        const filtered = data.transactions.filter(t => {
            const categoryName = (data.categories.find(c => c.id == t.category)?.name || '未分類').toLowerCase();
            const description = (t.description || '').toLowerCase();
            const searchMatch = !searchTerm || description.includes(searchTerm) || categoryName.includes(searchTerm);
            const categoryMatch = !categoryId || categoryId === 'all' || t.category == categoryId;
            return searchMatch && categoryMatch;
        });

        if (filtered.length === 0) {
            container.innerHTML = `<div class="no-data"><span class="material-symbols-outlined">search_off</span><p>找不到符合條件的交易紀錄。</p></div>`;
            return;
        }

        filtered.sort((a, b) => a.order - b.order);
        
        filtered.forEach(t => {
            const item = document.createElement('div');
            item.className = 'transaction-list-item';
            item.dataset.id = t.id;
            item.draggable = true;
            
            const categoryName = data.categories.find(c => c.id == t.category)?.name || '未分類';
            const displayDescription = highlightText(t.description || '<i>無備註</i>', searchTerm);
            const displayCategory = highlightText(categoryName, searchTerm);

            item.innerHTML = `
                <div class="transaction-icon ${t.type}">
                    <span class="material-symbols-outlined">${t.type === 'income' ? 'arrow_upward' : 'arrow_downward'}</span>
                </div>
                <div class="transaction-details">
                    <div class="description">${displayDescription}</div>
                    <div class="category-tag">${displayCategory}</div>
                </div>
                <div class="transaction-info">
                    <div class="amount ${t.type}">${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}</div>
                    <div class="date">${t.date}</div>
                </div>`;
            item.addEventListener('click', () => openTransactionModal(t.id));
            container.appendChild(item);
        });
    }

    function renderCategoryFilters() {
        const container = $('#category-filter-container');
        container.innerHTML = `<span class="filter-tag active" data-id="all">全部</span>`;
        data.categories.forEach(c => { container.innerHTML += `<span class="filter-tag" data-id="${c.id}">${c.name}</span>`; });
    }

    function renderCategories() {
        const list = $('#category-list');
        list.innerHTML = '';
        if (data.categories.length === 0) { list.innerHTML = `<div class="no-data"><span class="material-symbols-outlined">category</span><p>尚無自訂類別</p></div>`; return; }
        data.categories.forEach(c => {
            const item = document.createElement('div'); item.className = 'transaction-list-item'; item.style.cursor = 'default';
            item.innerHTML = `<span>${c.name}</span><div><button class="btn btn-sm btn-secondary edit-category-btn" data-id="${c.id}"><span class="material-symbols-outlined" style="margin:0;">edit</span></button><button class="btn btn-sm btn-danger delete-category-btn" data-id="${c.id}"><span class="material-symbols-outlined" style="margin:0;">delete</span></button></div>`;
            list.appendChild(item);
        });
    }

    function populateReportSelectors() {
        const yearSelectMonth = $('#report-month-year-select'); 
        const yearSelectYearly = $('#report-year-select');
        const monthSelect = $('#report-month-select');
        const dateSelect = $('#report-date-select');

        const transactionYears = data.transactions.map(t => new Date(t.date).getFullYear());
        const currentYear = new Date().getFullYear();
        if (!transactionYears.includes(currentYear)) { transactionYears.push(currentYear); }
        const years = [...new Set(transactionYears)].sort((a,b) => b-a);
        
        const yearOptions = years.length > 0 ? years.map(y => `<option value="${y}">${y}年</option>`).join('') : `<option value="${currentYear}">${currentYear}年</option>`;
        yearSelectMonth.innerHTML = yearOptions;
        yearSelectYearly.innerHTML = yearOptions;
        
        monthSelect.innerHTML = Array.from({length: 12}, (_, i) => `<option value="${i+1}">${i+1}月</option>`).join('');
        
        const now = new Date();
        if (years.includes(now.getFullYear())) {
            yearSelectMonth.value = now.getFullYear();
            yearSelectYearly.value = now.getFullYear();
        }
        monthSelect.value = now.getMonth() + 1;
        dateSelect.valueAsDate = now;
    }

    function renderReportData() {
        const activeTab = $('#report-tabs .active').dataset.reportType;
        let filtered = [];
        let chartTitlePrefix = '';

        if (activeTab === 'daily') {
            const date = $('#report-date-select').value;
            if(date) {
                filtered = data.transactions.filter(t => t.date === date);
                chartTitlePrefix = date;
            }
        } else if (activeTab === 'monthly') {
            const year = $('#report-month-year-select').value;
            const month = $('#report-month-select').value.padStart(2, '0');
            const monthStr = `${year}-${month}`;
            filtered = data.transactions.filter(t => t.date.startsWith(monthStr));
            chartTitlePrefix = `${year}年${parseInt(month, 10)}月`;
        } else if (activeTab === 'yearly') {
            const year = $('#report-year-select').value;
            filtered = data.transactions.filter(t => t.date.startsWith(year));
            chartTitlePrefix = `${year}年`;
        }

        const income = filtered.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
        const expense = filtered.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
        const balance = income - expense;
        
        $('#report-stats-results').innerHTML = `<div class="stat-item"><h4>總收入</h4><p class="income">${formatCurrency(income)}</p></div><div class="stat-item"><h4>總支出</h4><p class="expense">${formatCurrency(expense)}</p></div><div class="stat-item"><h4>淨收支</h4><p class="balance">${formatCurrency(balance)}</p></div>`;
        renderCategoryPieChart(filtered.filter(t => t.type === 'expense'), chartTitlePrefix);
    }
    
    function renderDashboardChart(period) {
        const ctx = $('#dashboard-chart').getContext('2d'); if (chartInstances.dashboard) chartInstances.dashboard.destroy();
        const style = getComputedStyle(document.documentElement);
        let labels = [], incomeData = [], expenseData = []; const now = new Date();
        if (period === 'day') {
            labels = Array.from({length: 7}, (_, i) => { const d = new Date(); d.setDate(d.getDate() - i); return d.toISOString().split('T')[0]; }).reverse();
            incomeData = Array(7).fill(0); expenseData = Array(7).fill(0);
            labels.forEach((label, index) => { data.transactions.forEach(t => { if (t.date === label) { if(t.type === 'income') incomeData[index] += t.amount; else expenseData[index] += t.amount; } }); });
            labels = labels.map(l => l.slice(5));
        } else if (period === 'month') {
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            labels = Array.from({length: daysInMonth}, (_, i) => i + 1);
            incomeData = Array(daysInMonth).fill(0); expenseData = Array(daysInMonth).fill(0);
            const currentMonthStr = now.toISOString().slice(0, 7);
            data.transactions.filter(t => t.date.startsWith(currentMonthStr)).forEach(t => {
                const day = new Date(t.date + 'T00:00:00').getDate() - 1;
                if(t.type === 'income') incomeData[day] += t.amount; else expenseData[day] += t.amount;
            });
        } else {
             labels = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
             incomeData = Array(12).fill(0); expenseData = Array(12).fill(0);
             const currentYear = now.getFullYear();
             data.transactions.filter(t => new Date(t.date).getFullYear() === currentYear).forEach(t => {
                const month = new Date(t.date + 'T00:00:00').getMonth();
                if(t.type === 'income') incomeData[month] += t.amount; else expenseData[month] += t.amount;
            });
        }
        chartInstances.dashboard = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [ { label: '收入', data: incomeData, borderColor: style.getPropertyValue('--income-color'), backgroundColor: style.getPropertyValue('--income-color')+'20', fill: true, tension: 0.3 }, { label: '支出', data: expenseData, borderColor: style.getPropertyValue('--expense-color'), backgroundColor: style.getPropertyValue('--expense-color')+'20', fill: true, tension: 0.3 } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: style.getPropertyValue('--border-color') }, ticks: { color: style.getPropertyValue('--text-light') } }, x: { grid: { color: style.getPropertyValue('--border-color') }, ticks: { color: style.getPropertyValue('--text-light') } } }, plugins: { legend: { labels: { color: style.getPropertyValue('--text-color') } } } } });
    }
    
    function renderCategoryPieChart(expenses, titlePrefix) {
        const container = $('#category-pie-chart').parentElement; const canvas = $('#category-pie-chart'); const noDataHTML = `<div class="no-data" style="position: absolute; top: 40%; left:0; right: 0;"><p>該範圍無支出紀錄</p></div>`;
        const style = getComputedStyle(document.documentElement);
        const existingNoData = container.querySelector('.no-data'); if(existingNoData) existingNoData.remove();
        canvas.style.display = 'block'; if (chartInstances.pie) chartInstances.pie.destroy();
        $('#category-pie-chart-title').textContent = `支出分類 (${titlePrefix})`;
        if (!expenses || expenses.length === 0) {
            canvas.style.display = 'none'; if(!container.querySelector('.no-data')) container.insertAdjacentHTML('beforeend', noDataHTML);
            return;
        }
        const expenseByCategory = expenses.reduce((acc, t) => {
            const categoryName = data.categories.find(c => c.id == t.category)?.name || '未分類';
            acc[categoryName] = (acc[categoryName] || 0) + t.amount; return acc;
        }, {});
        chartInstances.pie = new Chart(canvas.getContext('2d'), { type: 'pie', data: { labels: Object.keys(expenseByCategory), datasets: [{ data: Object.values(expenseByCategory), backgroundColor: ['#58a6ff', '#50e3c2', '#f5a623', '#bd10e0', '#f85149', '#9b59b6', '#34495e', '#1abc9c', '#f1c40f', '#d35400'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: style.getPropertyValue('--text-color') } } } } });
    }

    function renderBudgets() {
        const container = $('#budget-form-container');
        container.innerHTML = '';
        const expenseCategories = data.categories.filter(c => {
            const isUsedAsExpense = data.transactions.some(t => t.category === c.id && t.type === 'expense');
            const isUsedAsIncome = data.transactions.some(t => t.category === c.id && t.type === 'income');
            return isUsedAsExpense || !isUsedAsIncome;
        });

        if (expenseCategories.length === 0) {
            container.innerHTML = `<p class="no-data">請先新增支出類別以設定預算。</p>`;
            return;
        }
        
        const now = new Date();
        const monthStr = now.toISOString().slice(0, 7);
        const monthlyTransactions = data.transactions.filter(t => t.date.startsWith(monthStr) && t.type === 'expense');

        expenseCategories.forEach(c => {
            const budgetAmount = data.budgets[c.id] || 0;
            const spentAmount = monthlyTransactions.filter(t => t.category == c.id).reduce((sum, t) => sum + t.amount, 0);
            const remaining = budgetAmount - spentAmount;
            const percentage = budgetAmount > 0 ? Math.min((spentAmount / budgetAmount) * 100, 100) : 0;
            
            let progressBarClass = 'progress-bar';
            if (percentage >= 100) progressBarClass += ' danger';
            else if (percentage > 80) progressBarClass += ' warning';
            
            let remainingClass = 'budget-remaining';
            if (remaining < 0) remainingClass += ' negative';

            const budgetCardHTML = `
                <div class="budget-card">
                    <div class="budget-card-header">${c.name}</div>
                    <div class="budget-card-body">
                        <div class="budget-input-area">
                            <span>$</span>
                            <input type="number" class="budget-input" data-id="${c.id}" placeholder="點此設定預算" value="${budgetAmount > 0 ? budgetAmount : ''}" min="0" step="any">
                        </div>
                        <div class="budget-progress-area">
                             <div class="progress-bar-container">
                                <div class="${progressBarClass}" style="width: ${percentage}%;"></div>
                            </div>
                            <div class="budget-summary-text">
                                <span>已用: ${formatCurrency(spentAmount)}</span>
                                <span class="${remainingClass}">剩餘: ${formatCurrency(remaining)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += budgetCardHTML;
        });
    }
    
    function renderDashboardSalaryClaim() {
        const container = $('#salary-claim-container');
        container.innerHTML = '';
        if (!data.salary.showClaimButton) {
            return;
        }

        const now = new Date();
        const currentMonthStr = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
        const isClaimed = data.salary.lastClaimedMonth === currentMonthStr;
        const isConfigured = data.salary.amount > 0 && data.salary.categoryId;

        let buttonHTML;
        let reclaimHTML = '';

        if (!isConfigured) {
            buttonHTML = `<button class="btn btn-primary" disabled>請先設定薪資金額與類別</button>`;
        } else if (isClaimed) {
            buttonHTML = `<button class="btn btn-primary" disabled><span class="material-symbols-outlined">check_circle</span>本月薪資已領取</button>`;
            reclaimHTML = `<div style="text-align: center; margin-top: 0.5rem;">
                <a href="#" id="reclaim-salary-btn" style="font-size: 0.9rem; color: var(--primary-color); text-decoration: underline;">撤銷上次領取</a>
            </div>`;
        } else {
            buttonHTML = `<button id="claim-salary-btn" class="btn btn-primary"><span class="material-symbols-outlined">payments</span>領取本月薪資 (${formatCurrency(data.salary.amount)})</button>`;
        }

        container.innerHTML = `<div class="card">${buttonHTML}${reclaimHTML}</div>`;
    }

    function renderDashboardBudgetTracking() {
        const container = $('#budget-tracking-container');
        container.innerHTML = '<h3>本月預算追蹤</h3>';
        
        const budgetedCategories = Object.keys(data.budgets).filter(id => data.budgets[id] > 0);

        if (budgetedCategories.length === 0) {
            container.innerHTML += '<p style="color: var(--text-light); font-size: 0.9rem;">尚未設定任何預算。<br><a href="#" id="go-to-budgets-from-dashboard">點此設定</a></p>';
            return;
        }

        const now = new Date();
        const monthStr = now.toISOString().slice(0, 7);
        const monthlyTransactions = data.transactions.filter(t => t.date.startsWith(monthStr) && t.type === 'expense');
        
        budgetedCategories.forEach(id => {
            const category = data.categories.find(c => c.id == id);
            if (!category) return;

            const budgetAmount = data.budgets[id];
            const spentAmount = monthlyTransactions
                .filter(t => t.category == id)
                .reduce((sum, t) => sum + t.amount, 0);
            
            const percentage = budgetAmount > 0 ? Math.min((spentAmount / budgetAmount) * 100, 100) : 0;
            let progressBarClass = 'progress-bar';
            if (percentage >= 100) progressBarClass += ' danger';
            else if (percentage > 80) progressBarClass += ' warning';
            
            container.innerHTML += `
                <div class="budget-item">
                    <label>${category.name}</label>
                    <div class="progress-bar-container">
                        <div class="${progressBarClass}" style="width: ${percentage}%;"></div>
                    </div>
                    <div class="budget-text">
                        <span>${formatCurrency(spentAmount)}</span>
                        <span>${formatCurrency(budgetAmount)}</span>
                    </div>
                </div>
            `;
        });
    }

    function renderSalaryManagement() {
        const amountInput = $('#salary-amount');
        const categorySelect = $('#salary-category');
        amountInput.value = data.salary.amount > 0 ? data.salary.amount : '';
        
        const incomeCategories = data.categories.filter(c => {
            const isUsedAsIncome = data.transactions.some(t => t.category === c.id && t.type === 'income');
            const isUsedAsExpense = data.transactions.some(t => t.category === c.id && t.type === 'expense');
            return isUsedAsIncome || !isUsedAsExpense;
        });
        
        categorySelect.innerHTML = '<option value="">-- 請選擇 --</option>' + incomeCategories.map(c => 
            `<option value="${c.id}" ${data.salary.categoryId == c.id ? 'selected' : ''}>${c.name}</option>`
        ).join('');
        
        if (data.salary.showClaimButton) {
            $('#claim-salary-on').checked = true;
        } else {
            $('#claim-salary-off').checked = true;
        }
    }
    
    function renderSurplusManagement() {
        const now = new Date();
        const monthStr = now.toISOString().slice(0, 7);
        const monthlyTransactions = data.transactions.filter(t => t.date.startsWith(monthStr));
        
        const salaryAmount = data.salary.amount || 0;
        const otherIncome = monthlyTransactions
            .filter(t => t.type === 'income' && t.category != data.salary.categoryId)
            .reduce((sum, t) => sum + t.amount, 0);
        const totalExpenses = monthlyTransactions
            .filter(t => t.type === 'expense')
            .reduce((sum, t) => sum + t.amount, 0);
        
        const totalIncome = salaryAmount + otherIncome;
        const surplus = totalIncome - totalExpenses;
        
        const surplusTotalEl = $('#surplus-total');
        surplusTotalEl.textContent = formatCurrency(surplus);
        surplusTotalEl.style.color = surplus >= 0 ? 'var(--income-color)' : 'var(--expense-color)';
        
        const breakdownContainer = $('#surplus-breakdown');
        breakdownContainer.innerHTML = `
            <div class="stat-item"><h4>設定薪水</h4><p class="income">${formatCurrency(salaryAmount)}</p></div>
            <div class="stat-item"><h4>其他收入</h4><p class="income">${formatCurrency(otherIncome)}</p></div>
            <hr style="grid-column: 1 / -1; border: none; border-top: 1px solid var(--border-color); margin: 0.5rem 0;">
            <div class="stat-item"><h4>總收入</h4><p class="income" style="font-weight:700;">${formatCurrency(totalIncome)}</p></div>
            <div class="stat-item"><h4>總支出</h4><p class="expense" style="font-weight:700;">${formatCurrency(totalExpenses)}</p></div>
        `;
    }

    function openModal(modalId) { $(`#${modalId}`).classList.add('active'); }
    function closeModal(modalId) { $(`#${modalId}`).classList.remove('active'); }
    function openTransactionModal(transactionId = null) {
        const form = $('#transaction-form'); form.reset(); $('#date').valueAsDate = new Date();
        const select = $('#category'); select.innerHTML = data.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        const deleteBtn = $('#delete-transaction-btn');
        if (transactionId) {
            const t = data.transactions.find(t => t.id === transactionId);
            $('#transaction-modal-title').textContent = '編輯交易'; $('#transaction-id').value = t.id;
            $(`input[name="type"][value="${t.type}"]`).checked = true;
            $('#amount').value = t.amount; $('#category').value = t.category; $('#date').value = t.date; $('#description').value = t.description;
            deleteBtn.style.display = 'inline-flex';
        } else {
            $('#transaction-modal-title').textContent = '新增交易'; $('#transaction-id').value = ''; deleteBtn.style.display = 'none';
        }
        openModal('transaction-modal');
    }
    function openCategoryModal(categoryId = null) {
        const form = $('#category-form'); form.reset();
        if (categoryId) {
            const c = data.categories.find(c => c.id === categoryId);
            $('#category-modal-title').textContent = '編輯類別'; $('#category-id').value = c.id; $('#category-name').value = c.name;
        } else {
            $('#category-modal-title').textContent = '新增類別'; $('#category-id').value = '';
        }
        openModal('category-modal');
    }
    
    function setupEventListeners() {
        document.body.addEventListener('click', e => {
            const navBtn = e.target.closest('.nav-btn');
            if (navBtn) {
                const pageId = navBtn.dataset.page;
                const mainPages = ['dashboard', 'transactions', 'reports', 'financial-management', 'others'];
                const desktopNavPages = ['categories', 'calculator'];
                const isSubPage = !mainPages.includes(pageId) && !desktopNavPages.includes(pageId);
                navigateTo(pageId, isSubPage);
            }
            const fmSubPageBtn = e.target.closest('[data-target-page]');
            if(fmSubPageBtn) {
                navigateTo(fmSubPageBtn.dataset.targetPage, true);
            }

            if (e.target.closest('#nav-add-mobile') || e.target.closest('#nav-add-desktop')) openTransactionModal();
            if (e.target.closest('#go-to-financial-management-btn')) navigateTo('financial-management');
            if (e.target.closest('#go-to-categories-btn')) navigateTo('categories', true);
            if (e.target.closest('#go-to-data-btn')) navigateTo('data', true);
            if (e.target.closest('#go-to-about-btn')) navigateTo('about', true);
            if (e.target.closest('#go-to-calculator-btn')) navigateTo('calculator', true);
            
            if (e.target.closest('#save-budgets-btn')) handleSaveBudgets();
            if (e.target.closest('#save-salary-btn')) handleSaveSalary();
            if (e.target.closest('#claim-salary-btn')) handleClaimSalary();
            if (e.target.closest('#reclaim-salary-btn')) { e.preventDefault(); handleReclaimSalary(); }

            // Animation
            if (e.target.closest('#play-animation-btn')) startAnimation();
            if (e.target.closest('#animation-play-pause-btn')) togglePlayPause();
            if (e.target.closest('#animation-close-btn')) closeAnimation();

            if (e.target.closest('#go-to-budgets-from-dashboard')) {
                e.preventDefault(); 
                if (window.innerWidth <= 800) navigateTo('budgets', true);
                else navigateTo('budgets');
            }

            const backBtn = e.target.closest('.back-btn'); if (backBtn) navigateTo(backBtn.dataset.target);
            if (e.target.matches('.close-btn') && !e.target.closest('#animation-modal')) closeModal(e.target.closest('.modal').id);
            if (e.target.matches('.modal')) closeModal(e.target.id);

            if (e.target.closest('#add-category-btn')) openCategoryModal();
            const editCatBtn = e.target.closest('.edit-category-btn'); if (editCatBtn) openCategoryModal(parseInt(editCatBtn.dataset.id));
            const deleteCatBtn = e.target.closest('.delete-category-btn'); if (deleteCatBtn) handleDeleteCategory(parseInt(deleteCatBtn.dataset.id));
            if (e.target.closest('#delete-transaction-btn')) handleDeleteTransaction();
            if (e.target.closest('#export-data-btn')) exportData();
            if (e.target.closest('#import-data-btn')) $('#import-file-input').click();
            if (e.target.closest('#clear-data-btn')) clearAllData();
            const themeBtn = e.target.closest('[data-theme-value]'); if (themeBtn) applyTheme(themeBtn.dataset.themeValue);
            const calcTab = e.target.closest('#calculator-tabs .time-toggle-btn');
            if (calcTab) {
                $$('#calculator-tabs .time-toggle-btn').forEach(b => b.classList.remove('active'));
                calcTab.classList.add('active');
                $$('.calculator-pane').forEach(p => p.style.display = 'none');
                $(`.calculator-pane[data-pane="${calcTab.dataset.calculator}"]`).style.display = 'block';
            }
            const reportTab = e.target.closest('#report-tabs .time-toggle-btn');
            if (reportTab) {
                $$('#report-tabs .time-toggle-btn').forEach(b => b.classList.remove('active'));
                reportTab.classList.add('active');
                ['daily', 'monthly', 'yearly'].forEach(type => {
                    $(`#${type}-controls`).style.display = type === reportTab.dataset.reportType ? 'block' : 'none';
                });
                renderReportData();
            }
        });
        document.body.addEventListener('submit', e => {
            if (e.target.id === 'transaction-form') handleTransactionFormSubmit(e);
            if (e.target.id === 'category-form') handleCategoryFormSubmit(e);
            if (e.target.id === 'compound-interest-form') { e.preventDefault(); const P = parseFloat($('#ci-principal').value); const r = parseFloat($('#ci-rate').value) / 100; const t = parseFloat($('#ci-years').value); const n = parseInt($('#ci-compound-freq').value); const amount = P * Math.pow(1 + (r / n), n * t); const totalInterest = amount - P; $('#ci-future-value').textContent = formatCurrency(amount); $('#ci-total-interest').textContent = formatCurrency(totalInterest); $('#ci-result').style.display = 'block'; }
            if (e.target.id === 'loan-form') { e.preventDefault(); const P = parseFloat($('#loan-amount').value); const annualRate = parseFloat($('#loan-rate').value) / 100; const termYears = parseFloat($('#loan-term').value); const r = annualRate / 12; const n = termYears * 12; if (r > 0) { const M = P * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1); const totalPayment = M * n; const totalInterest = totalPayment - P; $('#loan-monthly-payment').textContent = formatCurrency(M); $('#loan-total-payment').textContent = formatCurrency(totalPayment); $('#loan-total-interest').textContent = formatCurrency(totalInterest); } else { $('#loan-monthly-payment').textContent = formatCurrency(P/n); $('#loan-total-payment').textContent = formatCurrency(P); $('#loan-total-interest').textContent = formatCurrency(0); } $('#loan-result').style.display = 'block'; }
            if (e.target.id === 'roi-form') { e.preventDefault(); const initial = parseFloat($('#roi-initial').value); const final = parseFloat($('#roi-final').value); if (initial > 0) { const netProfit = final - initial; const roi = (netProfit / initial) * 100; $('#roi-percentage').textContent = `${roi.toFixed(2)} %`; $('#roi-net-profit').textContent = formatCurrency(netProfit); } else { $('#roi-percentage').textContent = 'N/A'; $('#roi-net-profit').textContent = 'N/A'; } $('#roi-result').style.display = 'block'; }
        });
        
        $('#search-input').addEventListener('input', renderTransactions);
        $('#category-filter-container').addEventListener('click', e => {
            if(e.target.matches('.filter-tag')) { $$('#category-filter-container .filter-tag').forEach(tag => tag.classList.remove('active')); e.target.classList.add('active'); renderTransactions(); }
        });
        $('#page-dashboard .time-toggle').addEventListener('click', e => {
            if(e.target.matches('.time-toggle-btn')) { $$('#page-dashboard .time-toggle-btn').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); renderDashboard(); }
        });
        document.addEventListener('change', e => {
            if (e.target.matches('#report-month-year-select, #report-month-select, #report-year-select, #report-date-select')) renderReportData();
            if (e.target.matches('#import-file-input')) importData(e);
            if (e.target.id === 'animation-speed-select') changeAnimationSpeed();
        });
        
        const transactionListContainer = $('#transaction-list-container');
        transactionListContainer.addEventListener('dragstart', e => {
            draggedItem = e.target.closest('.transaction-list-item');
            if(draggedItem) setTimeout(() => draggedItem.classList.add('dragging'), 0);
        });
        transactionListContainer.addEventListener('dragend', () => {
            if(draggedItem) draggedItem.classList.remove('dragging');
            draggedItem = null;
        });
        transactionListContainer.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(transactionListContainer, e.clientY);
            $$('.drag-over').forEach(el => el.classList.remove('drag-over'));
            if(afterElement) afterElement.classList.add('drag-over');
        });
        transactionListContainer.addEventListener('drop', e => {
            e.preventDefault();
            $$('.drag-over').forEach(el => el.classList.remove('drag-over'));
            if (!draggedItem) return;
            const afterElement = getDragAfterElement(transactionListContainer, e.clientY);
            const draggedId = parseInt(draggedItem.dataset.id);
            const draggedTx = data.transactions.find(t => t.id === draggedId);
            const oldIndex = data.transactions.findIndex(t => t.id === draggedId);
            if (oldIndex > -1) data.transactions.splice(oldIndex, 1);
            if (afterElement == null) {
                data.transactions.push(draggedTx);
            } else {
                const afterId = parseInt(afterElement.dataset.id);
                const dropIndex = data.transactions.findIndex(t => t.id === afterId);
                data.transactions.splice(dropIndex, 0, draggedTx);
            }
            reindexOrder(); saveData(); renderTransactions();
        });
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.transaction-list-item:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function handleTransactionFormSubmit(e) {
        e.preventDefault(); const id = $('#transaction-id').value;
        const newTransaction = { id: id ? parseInt(id) : Date.now(), type: $('input[name="type"]:checked').value, amount: parseFloat($('#amount').value), category: parseInt($('#category').value), date: $('#date').value, description: $('#description').value.trim() };
        if (id) { 
            const index = data.transactions.findIndex(t => t.id == id);
            newTransaction.order = data.transactions[index].order;
            data.transactions[index] = newTransaction;
        } else { 
            data.transactions.unshift(newTransaction);
            reindexOrder();
        }
        saveData(); closeModal('transaction-modal'); updateAll();
    }
    function handleDeleteTransaction() {
        if (!confirm('您確定要刪除這筆交易嗎？此操作無法復原。')) return;
        const id = parseInt($('#transaction-id').value); 
        data.transactions = data.transactions.filter(t => t.id !== id);
        reindexOrder();
        saveData(); closeModal('transaction-modal'); updateAll();
    }
    function handleCategoryFormSubmit(e) {
        e.preventDefault(); const id = $('#category-id').value; const name = $('#category-name').value.trim(); if (!name) return;
        if (id) { data.categories.find(c => c.id == id).name = name; } else { data.categories.push({ id: Date.now(), name: name }); }
        saveData(); updateAll(); closeModal('category-modal');
    }
    function handleDeleteCategory(id) {
        if (!confirm('確定要刪除這個類別嗎？使用此類別的交易將被標示為「未分類」。')) return;
        data.categories = data.categories.filter(c => c.id !== id); 
        delete data.budgets[id];
        if (data.salary.categoryId == id) {
            data.salary.categoryId = null;
        }
        saveData(); updateAll();
    }
    function handleSaveBudgets() {
        $$('.budget-input').forEach(input => {
            const id = input.dataset.id;
            const amount = parseFloat(input.value);
            if (amount > 0) {
                data.budgets[id] = amount;
            } else {
                delete data.budgets[id];
            }
        });
        saveData();
        alert('預算已儲存！');
        navigateTo('dashboard');
    }
    function handleSaveSalary() {
        const amount = parseFloat($('#salary-amount').value);
        const categoryId = $('#salary-category').value;
        data.salary.amount = amount > 0 ? amount : 0;
        data.salary.categoryId = categoryId ? parseInt(categoryId) : null;
        data.salary.showClaimButton = $('#claim-salary-on').checked;
        saveData();
        alert('薪水設定已儲存！');
        navigateTo('financial-management');
    }

    function handleClaimSalary() {
        if (!data.salary.amount || !data.salary.categoryId) {
            alert('薪資設定不完整，無法領取。');
            return;
        }
        const now = new Date();
        const currentMonthStr = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;

        if (data.salary.lastClaimedMonth === currentMonthStr) {
            alert('本月薪資已經領取過了。');
            return;
        }
        
        const salaryCategoryName = data.categories.find(c => c.id == data.salary.categoryId)?.name || '薪資';

        const newTransaction = {
            id: Date.now(),
            type: 'income',
            amount: data.salary.amount,
            category: data.salary.categoryId,
            date: now.toISOString().split('T')[0],
            description: `${salaryCategoryName}`,
            isClaimedSalary: true
        };
        
        data.transactions.unshift(newTransaction);
        data.salary.lastClaimedMonth = currentMonthStr;
        reindexOrder();
        saveData();
        alert('薪資已領取！');
        updateAll();
    }

    function handleReclaimSalary() {
        if (!confirm('確定要撤銷上次領取的薪資嗎？這將會刪除對應的交易紀錄。')) {
            return;
        }
        const now = new Date();
        const currentMonthStr = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;

        const transactionIndex = data.transactions.findIndex(t => 
            t.isClaimedSalary === true && t.date.startsWith(currentMonthStr)
        );

        if (transactionIndex > -1) {
            data.transactions.splice(transactionIndex, 1);
            data.salary.lastClaimedMonth = null;
            reindexOrder();
            saveData();
            alert('薪資領取已撤銷。');
            updateAll();
        } else {
            alert('找不到可撤銷的薪資紀錄。');
        }
    }

    // --- Animation Logic ---
    function startAnimation() {
        const now = new Date();
        const monthStr = now.toISOString().slice(0, 7);
        animationTransactions = data.transactions
            .filter(t => t.date.startsWith(monthStr))
            .sort((a,b) => new Date(a.date) - new Date(b.date));
        
        if (animationTransactions.length === 0) {
            alert('本月尚無交易紀錄可播放動畫。');
            return;
        }

        const firstDateOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        animationRunningBalance = data.transactions
            .filter(t => new Date(t.date) < firstDateOfMonth)
            .reduce((bal, t) => t.type === 'income' ? bal + t.amount : bal - t.amount, 0);

        animationIndex = 0;
        animationSpeed = parseInt($('#animation-speed-select').value);
        
        $('#animation-tx-item-container').innerHTML = '準備開始...';
        $('#animation-running-balance').textContent = formatCurrency(animationRunningBalance);
        $('#animation-progress-bar').style.width = '0%';
        
        const playPauseBtn = $('#animation-play-pause-btn');
        playPauseBtn.innerHTML = `<span class="material-symbols-outlined">pause</span>暫停`;

        openModal('animation-modal');
        playNextFrame();
        animationInterval = setInterval(playNextFrame, animationSpeed);
    }

    function playNextFrame() {
        if (animationIndex >= animationTransactions.length) {
            togglePlayPause(true); // End of animation
            return;
        }

        const tx = animationTransactions[animationIndex];
        const categoryName = data.categories.find(c => c.id == tx.category)?.name || '未分類';
        
        if(tx.type === 'income') {
            animationRunningBalance += tx.amount;
        } else {
            animationRunningBalance -= tx.amount;
        }

        const txHTML = `
            <div class="tx-item">
                <div class="tx-date">${tx.date}</div>
                <div class="tx-desc">${tx.description || '<i>無備註</i>'} (${categoryName})</div>
                <div class="tx-amount ${tx.type}">${tx.type === 'income' ? '+' : '-'}${formatCurrency(tx.amount)}</div>
            </div>
        `;
        
        $('#animation-tx-item-container').innerHTML = txHTML;
        $('#animation-running-balance').textContent = formatCurrency(animationRunningBalance);
        $('#animation-progress-bar').style.width = `${((animationIndex + 1) / animationTransactions.length) * 100}%`;

        animationIndex++;
    }

    function togglePlayPause(isFinished = false) {
        const playPauseBtn = $('#animation-play-pause-btn');
        if (animationInterval) { // Is playing, so pause
            clearInterval(animationInterval);
            animationInterval = null;
            playPauseBtn.innerHTML = `<span class="material-symbols-outlined">play_arrow</span>播放`;
        } else { // Is paused or finished
            if (animationIndex >= animationTransactions.length || isFinished) { // Replay
                startAnimation();
            } else { // Resume
                 playPauseBtn.innerHTML = `<span class="material-symbols-outlined">pause</span>暫停`;
                 animationInterval = setInterval(playNextFrame, animationSpeed);
            }
        }
        if (isFinished) {
            playPauseBtn.innerHTML = `<span class="material-symbols-outlined">replay</span>重播`;
        }
    }
    
    function changeAnimationSpeed() {
        animationSpeed = parseInt($('#animation-speed-select').value);
        if (animationInterval) { // If it's currently playing, restart the interval with new speed
            clearInterval(animationInterval);
            animationInterval = setInterval(playNextFrame, animationSpeed);
        }
    }
    
    function closeAnimation() {
        if(animationInterval) clearInterval(animationInterval);
        animationInterval = null;
        closeModal('animation-modal');
    }


    // --- Data Management ---
    function exportData() {
        const dataStr = JSON.stringify(data, null, 2); const blob = new Blob([dataStr], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `accounting-data-${new Date().toISOString().split('T')[0]}.json`;
        a.click(); URL.revokeObjectURL(a.href); a.remove();
    }
    function importData(event) {
        const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
        reader.onload = e => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData.transactions && importedData.categories) {
                    if (confirm('確定要匯入資料嗎？這將會覆蓋現有所有資料。')) { data = importedData; saveData(); alert('資料匯入成功！'); init(); }
                } else alert('檔案格式不正確！');
            } catch (error) { alert('讀取檔案失敗，請確認是否為有效的 JSON 檔案。'); }
        };
        reader.readAsText(file); event.target.value = '';
    }
    function clearAllData() {
        if (confirm('警告：此操作將永久刪除所有交易和類別資料，且無法復原。您確定要繼續嗎？')) {
            if (prompt('為防止誤觸，請輸入 "DELETE" 以確認刪除：') === 'DELETE') {
                data = {
                    transactions: [],
                    categories: [ { id: 1, name: '餐飲' }, { id: 2, name: '交通' }, { id: 3, name: '購物' }, { id: 4, name: '娛樂' }, { id: 5, name: '薪資' }, { id: 6, name: '投資' } ],
                    budgets: {},
                    salary: { amount: 0, categoryId: null, showClaimButton: false, lastClaimedMonth: null }
                };
                saveData(); alert('所有資料已清除，應用程式已重設。'); updateAll();
            } else { alert('輸入錯誤，操作已取消。'); }
        }
    }

    function formatCurrency(num) { return '$' + num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 }); }
    init();
});
</script>

</body>
</html>
