<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>精美記帳</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Inter font for a modern look */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">
    <div id="app-container" class="bg-white shadow-2xl rounded-3xl w-full max-w-md mx-auto overflow-hidden flex flex-col" style="min-height: 80vh;">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-6 rounded-t-3xl shadow-lg relative">
            <h1 class="text-3xl font-bold text-center mb-2">精美記帳</h1>
            <div id="loading-indicator" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white bg-opacity-30 rounded-full p-2 hidden">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow p-4 overflow-y-auto" id="main-app-content">
            <!-- Dashboard View -->
            <section id="dashboard-view" class="view active">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">儀表板</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-green-400 to-green-600 text-white p-5 rounded-xl shadow-md">
                        <p class="text-sm opacity-90">總餘額</p>
                        <p id="total-balance" class="text-3xl font-bold mt-1">$0.00</p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-400 to-blue-600 text-white p-5 rounded-xl shadow-md">
                        <p class="text-sm opacity-90">本月收入</p>
                        <p id="monthly-income-dashboard" class="text-3xl font-bold mt-1">$0.00</p>
                    </div>
                    <div class="bg-gradient-to-br from-red-400 to-red-600 text-white p-5 rounded-xl shadow-md">
                        <p class="text-sm opacity-90">本月支出</p>
                        <p id="monthly-expense" class="text-3xl font-bold mt-1">$0.00</p>
                    </div>
                </div>

                <h3 class="text-xl font-semibold text-gray-800 mb-3">近期交易</h3>
                <div id="recent-transactions-list" class="space-y-3">
                    <!-- Recent transactions will be loaded here -->
                    <p class="text-gray-500 text-center py-4" id="no-recent-transactions">尚無近期交易。</p>
                </div>
            </section>

            <!-- Add Transaction View -->
            <section id="add-transaction-view" class="view hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">新增交易</h2>
                <form id="transaction-form" class="space-y-4">
                    <div>
                        <label for="transaction-type" class="block text-sm font-medium text-gray-700 mb-1">類型</label>
                        <select id="transaction-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                            <option value="expense">支出</option>
                            <option value="income">收入</option>
                        </select>
                    </div>
                    <div>
                        <label for="transaction-amount" class="block text-sm font-medium text-gray-700 mb-1">金額</label>
                        <input type="number" id="transaction-amount" step="0.01" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200" placeholder="0.00">
                    </div>
                    <div>
                        <label for="transaction-category" class="block text-sm font-medium text-gray-700 mb-1">類別</label>
                        <select id="transaction-category" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                            <!-- Categories will be loaded here -->
                        </select>
                    </div>
                    <div>
                        <label for="transaction-date" class="block text-sm font-medium text-gray-700 mb-1">日期</label>
                        <input type="date" id="transaction-date" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                    </div>
                    <div>
                        <label for="transaction-description" class="block text-sm font-medium text-gray-700 mb-1">描述 (選填)</label>
                        <textarea id="transaction-description" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200" placeholder="例如：咖啡，晚餐"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-md">新增交易</button>
                </form>
            </section>

            <!-- Transactions List View -->
            <section id="transactions-list-view" class="view hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">所有交易</h2>
                <div class="mb-4 flex space-x-2">
                    <input type="text" id="filter-description" placeholder="按描述篩選..." class="flex-grow p-2 border border-gray-300 rounded-lg">
                    <select id="filter-category" class="p-2 border border-gray-300 rounded-lg">
                        <option value="">所有類別</option>
                        <!-- Categories will be loaded here -->
                    </select>
                    <select id="sort-order" class="p-2 border border-gray-300 rounded-lg">
                        <option value="desc">最新</option>
                        <option value="asc">最舊</option>
                    </select>
                </div>
                <div id="all-transactions-list" class="space-y-3">
                    <!-- All transactions will be loaded here -->
                    <p class="text-gray-500 text-center py-4" id="no-all-transactions">尚無交易記錄。</p>
                </div>
            </section>

            <!-- Categories View -->
            <section id="categories-view" class="view hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">類別管理</h2>
                <form id="add-category-form" class="flex mb-4 space-x-2">
                    <input type="text" id="new-category-name" placeholder="新增類別名稱" required class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                    <button type="submit" class="bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-300 shadow-md">新增</button>
                </form>
                <div id="categories-list" class="space-y-3">
                    <!-- Categories will be loaded here -->
                    <p class="text-gray-500 text-center py-4" id="no-categories">尚無自訂類別。</p>
                </div>
            </section>

            <!-- Reports View -->
            <section id="reports-view" class="view hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">報表</h2>

                <!-- Current Month Summary -->
                <div class="mb-6 bg-white p-4 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">本月概覽</h3>
                    <div id="current-month-summary" class="text-gray-700">
                        <p>本月收入: <span id="current-month-income" class="font-medium text-green-600">$0.00</span></p>
                        <p>本月支出: <span id="current-month-expense-summary" class="font-medium text-red-600">$0.00</span></p>
                        <p>本月結餘: <span id="current-month-balance" class="font-bold text-blue-600">$0.00</span></p>
                    </div>
                </div>

                <!-- Existing: Expense by Category Chart -->
                <div class="mb-6 bg-white p-4 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">按類別劃分的支出 (總覽)</h3>
                    <canvas id="expense-by-category-chart"></canvas>
                    <p class="text-gray-500 text-center py-4 hidden" id="no-expense-chart-data">尚無足夠資料生成圖表。</p>
                </div>

                <!-- New: Monthly Expense Breakdown by Category (List) -->
                <div class="mb-6 bg-white p-4 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">本月各類別支出明細</h3>
                    <div id="monthly-category-breakdown" class="space-y-2">
                        <p class="text-gray-500 text-center py-4" id="no-monthly-breakdown-data">本月尚無支出記錄。</p>
                    </div>
                </div>

                <!-- Existing: Monthly Income Expense Chart -->
                <div class="mb-6 bg-white p-4 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">月度收支趨勢</h3>
                    <canvas id="monthly-income-expense-chart"></canvas>
                    <p class="text-gray-500 text-center py-4 hidden" id="no-monthly-chart-data">尚無足夠資料生成圖表。</p>
                </div>

                <!-- Existing: Annual Summary -->
                <div class="mb-6 bg-white p-4 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">年度摘要</h3>
                    <div id="annual-summary" class="text-gray-700">
                        <p class="text-gray-500 text-center py-4" id="no-annual-summary">尚無年度摘要資料。</p>
                    </div>
                </div>
            </section>

            <!-- Shared View -->
            <section id="shared-view" class="view hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">共享與備份</h2>
                <div class="bg-gray-50 p-6 rounded-xl shadow-md text-center mb-6">
                    <p class="text-gray-700 text-lg font-semibold mb-4">
                        此功能僅支援透過 JSON 檔案匯入及匯出您的記帳資料。
                        <br>
                        請注意，其他共用功能已被暫時關閉，我們正在想辦法恢復公用功能，造成不便敬請見諒。
                    </p>
                    <div class="space-y-4">
                        <button id="export-data-btn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            匯出資料 (JSON)
                        </button>
                        <input type="file" id="import-file-input" accept=".json" class="hidden">
                        <button id="import-data-btn" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-300 shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 0 003-3v-1m-4-8l-4-4m0 0l-4 4m4-4v12" />
                            </svg>
                            匯入資料 (JSON)
                        </button>
                    </div>
                </div>
            </section>

            <!-- New: Announcement View for Login Status -->
            <section id="announcement-view" class="view hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">公告</h2>
                <div class="bg-gray-50 p-6 rounded-xl shadow-md text-center mb-6">
                    <p class="text-gray-700 text-lg font-semibold mb-4">
                        請注意有些登入功能已被暫時關閉，我們正在想辦法恢復登入功能，造成不便敬請見諒。
                    </p>
                </div>
            </section>

            <!-- About View -->
            <section id="about-view" class="view hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">關於</h2>
                <div class="bg-gray-50 p-6 rounded-xl shadow-md text-center">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">精美記帳應用程式</h3>
                    <p class="text-gray-700 mb-2">版本: 2.3.0 (純本地儲存與JSON匯入匯出)</p>
                    <p class="text-gray-700 mb-4">一個簡單、美觀的個人記帳工具，資料儲存在您的瀏覽器中。</p>
                    <p class="text-gray-600 text-sm">
                        此應用程式由 AI 助手為您生成。
                        <br>
                        如果您有任何功能建議或需要進一步的客製化，歡迎提出！
                    </p>
                </div>
            </section>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bg-white border-t border-gray-200 p-3 flex justify-around shadow-inner rounded-b-3xl" id="bottom-nav">
            <button class="nav-item flex flex-col items-center text-gray-600 hover:text-blue-600 transition duration-200 active-nav" data-view="dashboard-view">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <span class="text-xs mt-1">儀表板</span>
            </button>
            <button class="nav-item flex flex-col items-center text-gray-600 hover:text-blue-600 transition duration-200" data-view="add-transaction-view">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-xs mt-1">新增</span>
            </button>
            <button class="nav-item flex flex-col items-center text-gray-600 hover:text-blue-600 transition duration-200" data-view="transactions-list-view">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
                <span class="text-xs mt-1">交易</span>
            </button>
            <button class="nav-item flex flex-col items-center text-gray-600 hover:text-blue-600 transition duration-200" data-view="categories-view">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                </svg>
                <span class="text-xs mt-1">類別</span>
            </button>
            <button class="nav-item flex flex-col items-center text-gray-600 hover:text-blue-600 transition duration-200" data-view="reports-view">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <span class="text-xs mt-1">報表</span>
            </button>
            <button class="nav-item flex flex-col items-center text-gray-600 hover:text-blue-600 transition duration-200" data-view="shared-view">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                </svg>
                <span class="text-xs mt-1">共享</span>
            </button>
            <button class="nav-item flex flex-col items-center text-gray-600 hover:text-blue-600 transition duration-200" data-view="announcement-view">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 17l-3 3m0 0l-3-3m3 3V3m6 14h2a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v12a2 2 0 002 2h2" />
                </svg>
                <span class="text-xs mt-1">公告</span>
            </button>
            <button class="nav-item flex flex-col items-center text-gray-600 hover:text-blue-600 transition duration-200" data-view="about-view">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-xs mt-1">關於</span>
            </button>
        </nav>

        <!-- Custom Modal for alerts/confirmations -->
        <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
                <p id="modal-message" class="text-lg font-semibold text-gray-800 mb-6"></p>
                <div id="modal-buttons" class="flex justify-center space-x-4">
                    <button id="modal-confirm-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 hidden">確認</button>
                    <button id="modal-cancel-btn" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-semibold hover:bg-gray-400 transition duration-300">關閉</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Global variables
        let db; // IndexedDB database instance
        let transactions = [];
        let categories = [];
        let expenseByCategoryChart;
        let monthlyIncomeExpenseChart;

        // DOM Elements
        const appContainer = document.getElementById('app-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const mainAppContent = document.getElementById('main-app-content');
        const bottomNav = document.getElementById('bottom-nav');

        // Views
        const dashboardView = document.getElementById('dashboard-view');
        const addTransactionView = document.getElementById('add-transaction-view');
        const transactionsListView = document.getElementById('transactions-list-view');
        const categoriesView = document.getElementById('categories-view');
        const reportsView = document.getElementById('reports-view');
        const sharedView = document.getElementById('shared-view');
        const announcementView = document.getElementById('announcement-view');
        const aboutView = document.getElementById('about-view');

        // Dashboard Elements
        const totalBalanceEl = document.getElementById('total-balance');
        const monthlyIncomeDashboardEl = document.getElementById('monthly-income-dashboard');
        const monthlyExpenseEl = document.getElementById('monthly-expense');
        const recentTransactionsList = document.getElementById('recent-transactions-list');
        const noRecentTransactions = document.getElementById('no-recent-transactions');

        // Add Transaction Form Elements
        const transactionForm = document.getElementById('transaction-form');
        const transactionTypeEl = document.getElementById('transaction-type');
        const transactionAmountEl = document.getElementById('transaction-amount');
        const transactionCategoryEl = document.getElementById('transaction-category');
        const transactionDateEl = document.getElementById('transaction-date');
        const transactionDescriptionEl = document.getElementById('transaction-description');

        // Transactions List Elements
        const allTransactionsList = document.getElementById('all-transactions-list');
        const noAllTransactions = document.getElementById('no-all-transactions');
        const filterDescriptionEl = document.getElementById('filter-description');
        const filterCategoryEl = document.getElementById('filter-category');
        const sortOrderEl = document.getElementById('sort-order');

        // Categories Elements
        const addCategoryForm = document.getElementById('add-category-form');
        const newCategoryNameEl = document.getElementById('new-category-name');
        const categoriesListEl = document.getElementById('categories-list');
        const noCategories = document.getElementById('no-categories');

        // Reports Elements
        const currentMonthIncomeEl = document.getElementById('current-month-income');
        const currentMonthExpenseSummaryEl = document.getElementById('current-month-expense-summary');
        const currentMonthBalanceEl = document.getElementById('current-month-balance');
        const expenseByCategoryChartCtx = document.getElementById('expense-by-category-chart').getContext('2d');
        const monthlyCategoryBreakdownEl = document.getElementById('monthly-category-breakdown');
        const noMonthlyBreakdownData = document.getElementById('no-monthly-breakdown-data');
        const monthlyIncomeExpenseChartCtx = document.getElementById('monthly-income-expense-chart').getContext('2d');
        const noExpenseChartData = document.getElementById('no-expense-chart-data');
        const noMonthlyChartData = document.getElementById('no-monthly-chart-data');
        const annualSummaryEl = document.getElementById('annual-summary');
        const noAnnualSummary = document.getElementById('no-annual-summary');

        // Shared View Elements
        const exportDataBtn = document.getElementById('export-data-btn');
        const importFileInput = document.getElementById('import-file-input');
        const importDataBtn = document.getElementById('import-data-btn');

        // Modal Elements
        const customModal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        let modalCallback = null;

        // --- Utility Functions ---

        /**
         * Shows a custom modal dialog.
         * @param {string} message - The message to display.
         * @param {'alert'|'confirm'} type - Type of modal ('alert' or 'confirm').
         * @param {function} [callback] - Callback function for 'confirm' type.
         */
        function showModal(message, type = 'alert', callback = null) {
            modalMessage.textContent = message;
            modalCallback = callback;

            if (type === 'confirm') {
                modalConfirmBtn.classList.remove('hidden');
                modalConfirmBtn.onclick = () => {
                    if (modalCallback) modalCallback(true);
                    customModal.classList.add('hidden');
                };
                modalCancelBtn.textContent = '取消';
            } else {
                modalConfirmBtn.classList.add('hidden');
                modalCancelBtn.textContent = '關閉';
            }

            modalCancelBtn.onclick = () => {
                if (type === 'confirm' && modalCallback) modalCallback(false);
                customModal.classList.add('hidden');
            };

            customModal.classList.remove('hidden');
        }

        /**
         * Displays the specified view and hides others.
         * @param {string} viewId - The ID of the view to display.
         */
        function displayView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');

            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active-nav', 'text-blue-600');
                item.classList.add('text-gray-600');
            });
            const activeNavItem = document.querySelector(`.nav-item[data-view="${viewId}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active-nav', 'text-blue-600');
                activeNavItem.classList.remove('text-gray-600');
            }

            // Re-render charts if reports view is active
            if (viewId === 'reports-view') {
                generateReports();
            }
        }

        /**
         * Shows or hides the loading indicator.
         * @param {boolean} show - True to show, false to hide.
         */
        function showLoading(show) {
            if (show) {
                loadingIndicator.classList.remove('hidden');
            } else {
                loadingIndicator.classList.add('hidden');
            }
        }

        /**
         * Formats a number as currency.
         * @param {number} amount - The amount to format.
         * @returns {string} Formatted currency string.
         */
        function formatCurrency(amount) {
            return `$${amount.toFixed(2)}`;
        }

        // --- IndexedDB Functions ---

        /**
         * Opens the IndexedDB database.
         * @returns {Promise<IDBDatabase>} The IndexedDB database instance.
         */
        function openIndexedDB() {
            console.log("IndexedDB: Attempting to open database 'FinanceTrackerDB', version 1.");
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('FinanceTrackerDB', 1);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    console.log("IndexedDB: onupgradeneeded triggered.");
                    if (!db.objectStoreNames.contains('transactions')) {
                        console.log("IndexedDB: Creating 'transactions' object store.");
                        db.createObjectStore('transactions', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('categories')) {
                        console.log("IndexedDB: Creating 'categories' object store.");
                        db.createObjectStore('categories', { keyPath: 'id' });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log("IndexedDB: Database opened successfully.", db);
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error("IndexedDB: Error opening database:", event.target.errorCode, event.target.error);
                    reject("無法開啟資料庫。");
                };
            });
        }

        /**
         * Saves data to IndexedDB.
         * @param {string} storeName - The name of the object store.
         * @param {object} data - The data object to save.
         */
        async function saveToIndexedDB(storeName, data) {
            showLoading(true);
            try {
                if (!db) {
                    console.error(`saveToIndexedDB(${storeName}): IndexedDB instance is not available.`);
                    throw new Error("IndexedDB instance is not available.");
                }
                console.log(`saveToIndexedDB(${storeName}): Starting transaction for ID: ${data.id}`);
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                await new Promise((resolve, reject) => {
                    const request = store.put(data); // Directly put data
                    request.onsuccess = () => {
                        console.log(`saveToIndexedDB(${storeName}): Data saved successfully for ID: ${data.id}`);
                        resolve();
                    };
                    request.onerror = (event) => {
                        console.error(`saveToIndexedDB(${storeName}): Error saving data for ID ${data.id}:`, event.target.error);
                        reject(event.target.error);
                    };
                });
            } catch (error) {
                console.error(`saveToIndexedDB(${storeName}): Caught error:`, error);
                showModal(`儲存資料失敗 (${storeName})。`, 'alert');
                throw error; // Re-throw to propagate the error
            } finally {
                showLoading(false);
            }
        }

        /**
         * Loads all data from an IndexedDB object store.
         * @param {string} storeName - The name of the object store.
         * @returns {Promise<Array<object>>} Data array.
         */
        async function loadFromIndexedDB(storeName) {
            showLoading(true);
            try {
                if (!db) {
                    console.error(`loadFromIndexedDB(${storeName}): IndexedDB instance is not available.`);
                    throw new Error("IndexedDB instance is not available.");
                }
                console.log(`loadFromIndexedDB(${storeName}): Starting transaction.`);
                const tx = db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                const request = store.getAll();

                const items = await new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        console.log(`loadFromIndexedDB(${storeName}): Loaded ${request.result.length} items.`);
                        resolve(request.result);
                    };
                    request.onerror = (event) => {
                        console.error(`loadFromIndexedDB(${storeName}): Error loading data:`, event.target.error);
                        reject(event.target.error);
                    };
                });
                return items;
            } catch (error) {
                console.error(`loadFromIndexedDB(${storeName}): Caught error:`, error);
                showModal(`載入資料失敗 (${storeName})。`, 'alert');
                throw error; // Re-throw the error to ensure initApp catches it.
            } finally {
                showLoading(false);
            }
        }

        /**
         * Deletes an item from IndexedDB.
         * @param {string} storeName - The name of the object store.
         * @param {string} id - The ID of the item to delete.
         */
        async function deleteFromIndexedDB(storeName, id) {
            showLoading(true);
            try {
                if (!db) {
                    console.error(`deleteFromIndexedDB(${storeName}): IndexedDB instance is not available.`);
                    throw new Error("IndexedDB instance is not available.");
                }
                console.log(`deleteFromIndexedDB(${storeName}): Starting delete transaction for ID: ${id}`);
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                await new Promise((resolve, reject) => {
                    const request = store.delete(id);
                    request.onsuccess = () => {
                        console.log(`deleteFromIndexedDB(${storeName}): Data deleted successfully for ID: ${id}`);
                        resolve();
                    };
                    request.onerror = (event) => {
                        console.error(`deleteFromIndexedDB(${storeName}): Error deleting data for ID ${id}:`, event.target.error);
                        reject(event.target.error);
                    };
                });
            } catch (error) {
                console.error(`deleteFromIndexedDB(${storeName}): Caught error:`, error);
                showModal(`刪除資料失敗 (${storeName})。`, 'alert');
                throw error; // Re-throw to propagate the error
            } finally {
                showLoading(false);
            }
        }

        /**
         * Clears all data from a specific IndexedDB object store.
         * @param {string} storeName - The name of the object store to clear.
         */
        async function clearObjectStore(storeName) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                const request = store.clear();
                request.onsuccess = () => {
                    console.log(`IndexedDB: Object store '${storeName}' cleared.`);
                    resolve();
                };
                request.onerror = (event) => {
                    console.error(`IndexedDB: Error clearing object store '${storeName}':`, event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // --- App Initialization ---

        /**
         * Initializes the application and loads data.
         */
        async function initApp() {
            console.log("initApp: Starting initialization.");
            showLoading(true);
            try {
                console.log("initApp: Opening IndexedDB.");
                await openIndexedDB();
                console.log("initApp: IndexedDB opened successfully. DB instance:", db);

                console.log("initApp: Loading categories.");
                await loadCategories();
                console.log("initApp: Categories loaded.");

                console.log("initApp: Loading transactions.");
                await loadTransactions();
                console.log("initApp: Transactions loaded.");

                mainAppContent.classList.remove('hidden');
                bottomNav.classList.remove('hidden');
                displayView('dashboard-view'); // Show dashboard on load
                console.log("initApp: Application fully initialized.");

            } catch (error) {
                console.error("initApp: Application initialization failed:", error);
                showModal("應用程式初始化失敗。請檢查您的瀏覽器設定。", 'alert');
            } finally {
                showLoading(false);
                console.log("initApp: Initialization process finished.");
            }
        }

        // --- Data Loading and Display ---

        /**
         * Loads categories from IndexedDB and updates the UI.
         */
        async function loadCategories() {
            try {
                categories = await loadFromIndexedDB('categories');
                renderCategories();
                populateCategorySelects();
            } catch (error) {
                console.error("loadCategories: Failed to load categories, proceeding with empty data.", error);
                categories = []; // Ensure categories array is reset on error
                renderCategories();
                populateCategorySelects();
            }
        }

        /**
         * Renders categories in the categories management view.
         */
        function renderCategories() {
            categoriesListEl.innerHTML = '';
            if (categories.length === 0) {
                noCategories.classList.remove('hidden');
            } else {
                noCategories.classList.add('hidden');
                categories.forEach(category => {
                    const categoryItem = document.createElement('div');
                    categoryItem.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg shadow-sm';
                    categoryItem.innerHTML = `
                        <span class="text-gray-800 font-medium">${category.name}</span>
                        <button class="delete-category-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition duration-200" data-id="${category.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    `;
                    categoriesListEl.appendChild(categoryItem);
                });

                document.querySelectorAll('.delete-category-btn').forEach(button => {
                    button.onclick = (e) => deleteCategory(e.currentTarget.dataset.id);
                });
            }
        }

        /**
         * Populates category select dropdowns.
         */
        function populateCategorySelects() {
            const categorySelects = [transactionCategoryEl, filterCategoryEl];
            categorySelects.forEach(selectEl => {
                selectEl.innerHTML = ''; // Clear existing options
                if (selectEl.id === 'filter-category') {
                    const allOption = document.createElement('option');
                    allOption.value = '';
                    allOption.textContent = '所有類別';
                    selectEl.appendChild(allOption);
                } else {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = '選擇類別';
                    defaultOption.disabled = true;
                    defaultOption.selected = true;
                    selectEl.appendChild(defaultOption);
                }

                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id; // Use category ID as value
                    option.textContent = category.name;
                    selectEl.appendChild(option);
                });
            });
        }

        /**
         * Loads transactions from IndexedDB and updates the UI.
         */
        async function loadTransactions() {
            try {
                transactions = await loadFromIndexedDB('transactions');
                // Ensure date is a Date object for easier manipulation
                transactions.forEach(t => t.date = new Date(t.date));
                renderDashboard();
                renderAllTransactions();
                generateReports(); // Regenerate reports when transactions change
            } catch (error) {
                console.error("loadTransactions: Failed to load transactions, proceeding with empty data.", error);
                transactions = []; // Ensure transactions array is reset on error
                renderDashboard();
                renderAllTransactions();
                generateReports();
            }
        }

        /**
         * Renders the dashboard view.
         */
        function renderDashboard() {
            let totalBalance = 0;
            let monthlyExpense = 0;
            let monthlyIncome = 0;
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            transactions.forEach(t => {
                if (t.type === 'income') {
                    totalBalance += t.amount;
                    if (t.date.getMonth() === currentMonth && t.date.getFullYear() === currentYear) {
                        monthlyIncome += t.amount;
                    }
                } else {
                    totalBalance -= t.amount;
                    if (t.date.getMonth() === currentMonth && t.date.getFullYear() === currentYear) {
                        monthlyExpense += t.amount;
                    }
                }
            });

            totalBalanceEl.textContent = formatCurrency(totalBalance);
            monthlyIncomeDashboardEl.textContent = formatCurrency(monthlyIncome);
            monthlyExpenseEl.textContent = formatCurrency(monthlyExpense);

            // Display recent transactions (e.g., last 5)
            recentTransactionsList.innerHTML = '';
            // Sort by date descending to get recent ones
            const sortedTransactions = [...transactions].sort((a, b) => b.date.getTime() - a.date.getTime());
            const recent = sortedTransactions.slice(0, 5); // Get latest 5 transactions
            if (recent.length === 0) {
                noRecentTransactions.classList.remove('hidden');
            } else {
                noRecentTransactions.classList.add('hidden');
                recent.forEach(t => {
                    const categoryName = categories.find(c => c.id === t.category)?.name || '未知類別';
                    const transactionItem = document.createElement('div');
                    transactionItem.className = `flex justify-between items-center p-3 rounded-lg shadow-sm ${t.type === 'income' ? 'bg-green-50' : 'bg-red-50'}`;
                    transactionItem.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-800">${categoryName}</p>
                            <p class="text-sm text-gray-500">${t.description || '無描述'} - ${t.date.toLocaleDateString()}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="font-semibold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}</span>
                            <button class="delete-transaction-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition duration-200" data-id="${t.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    `;
                    recentTransactionsList.appendChild(transactionItem);
                });
            }
        }

        /**
         * Renders all transactions in the transactions list view, applying filters and sorting.
         */
        function renderAllTransactions() {
            let filteredTransactions = [...transactions];

            // Apply description filter
            const descriptionFilter = filterDescriptionEl.value.toLowerCase();
            if (descriptionFilter) {
                filteredTransactions = filteredTransactions.filter(t =>
                    t.description && t.description.toLowerCase().includes(descriptionFilter)
                );
            }

            // Apply category filter
            const categoryFilter = filterCategoryEl.value;
            if (categoryFilter) {
                filteredTransactions = filteredTransactions.filter(t => t.category === categoryFilter);
            }

            // Apply sorting
            const sortOrder = sortOrderEl.value;
            filteredTransactions.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });


            allTransactionsList.innerHTML = '';
            if (filteredTransactions.length === 0) {
                noAllTransactions.classList.remove('hidden');
            } else {
                noAllTransactions.classList.add('hidden');
                filteredTransactions.forEach(t => {
                    const categoryName = categories.find(c => c.id === t.category)?.name || '未知類別';
                    const transactionItem = document.createElement('div');
                    transactionItem.className = `flex justify-between items-center p-3 rounded-lg shadow-sm ${t.type === 'income' ? 'bg-green-50' : 'bg-red-50'}`;
                    transactionItem.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-800">${categoryName}</p>
                            <p class="text-sm text-gray-500">${t.description || '無描述'} - ${t.date.toLocaleDateString()}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="font-semibold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}</span>
                            <button class="delete-transaction-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition duration-200" data-id="${t.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    `;
                    allTransactionsList.appendChild(transactionItem);
                });

                document.querySelectorAll('.delete-transaction-btn').forEach(button => {
                    button.onclick = (e) => deleteTransaction(e.currentTarget.dataset.id);
                });
            }
        }


        // --- Transaction Management ---

        /**
         * Handles adding a new transaction.
         * @param {Event} e - The form submission event.
         */
        async function addTransaction(e) {
            e.preventDefault();
            showLoading(true);

            const type = transactionTypeEl.value;
            const amount = parseFloat(transactionAmountEl.value);
            const category = transactionCategoryEl.value;
            const date = transactionDateEl.value; // Store as string for IndexedDB
            const description = transactionDescriptionEl.value.trim();

            if (isNaN(amount) || amount <= 0 || !category || !date) {
                showModal("請填寫所有必填欄位並確保金額有效。", 'alert');
                showLoading(false);
                return;
            }

            const newTransaction = {
                id: crypto.randomUUID(), // Generate unique ID for IndexedDB
                type,
                amount,
                category,
                date,
                description,
                createdAt: new Date().toISOString(), // Timestamp for sorting
            };

            await saveToIndexedDB('transactions', newTransaction);
            transactionForm.reset();
            // Set default date to today after reset
            transactionDateEl.valueAsDate = new Date();
            showModal("交易新增成功！", 'alert');
            await loadTransactions(); // Reload transactions to update UI
            displayView('dashboard-view'); // Go back to dashboard after adding
            showLoading(false);
        }

        /**
         * Deletes a transaction from IndexedDB.
         * @param {string} id - The ID of the transaction to delete.
         */
        function deleteTransaction(id) {
            showModal("您確定要刪除這筆交易嗎？此操作無法撤銷。", 'confirm', async (confirmed) => {
                if (confirmed) {
                    showLoading(true);
                    await deleteFromIndexedDB('transactions', id);
                    showModal("交易已刪除。", 'alert');
                    await loadTransactions(); // Reload transactions to update UI
                    showLoading(false);
                }
            });
        }

        // --- Category Management ---

        /**
         * Handles adding a new category.
         * @param {Event} e - The form submission event.
         */
        async function addCategory(e) {
            e.preventDefault();
            showLoading(true);
            const categoryName = newCategoryNameEl.value.trim();

            if (!categoryName) {
                showModal("類別名稱不能為空。", 'alert');
                showLoading(false);
                return;
            }
            if (categories.some(c => c.name.toLowerCase() === categoryName.toLowerCase())) {
                showModal("此類別已存在。", 'alert');
                showLoading(false);
                return;
            }

            const newCategory = {
                id: crypto.randomUUID(), // Generate unique ID for IndexedDB
                name: categoryName,
                createdAt: new Date().toISOString(),
            };

            await saveToIndexedDB('categories', newCategory);
            newCategoryNameEl.value = '';
            showModal("類別新增成功！", 'alert');
            await loadCategories(); // Reload categories to update UI
            showLoading(false);
        }

        /**
         * Deletes a category from IndexedDB.
         * @param {string} id - The ID of the category to delete.
         */
        function deleteCategory(id) {
            showModal("您確定要刪除此類別嗎？所有相關交易將不再顯示類別名稱。", 'confirm', async (confirmed) => {
                if (confirmed) {
                    showLoading(true);
                    await deleteFromIndexedDB('categories', id);
                    showModal("類別已刪除。", 'alert');
                    await loadCategories(); // Reload categories to update UI
                    await loadTransactions(); // Transactions might need re-rendering if categories change
                    showLoading(false);
                }
            });
        }

        // --- Reports and Charts ---

        /**
         * Generates and renders all reports and charts.
         */
        function generateReports() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Current Month Summary
            let currentMonthIncome = 0;
            let currentMonthExpense = 0;
            const monthlyCategoryExpenses = {}; // For monthly breakdown

            transactions.forEach(t => {
                if (t.date.getMonth() === currentMonth && t.date.getFullYear() === currentYear) {
                    if (t.type === 'income') {
                        currentMonthIncome += t.amount;
                    } else {
                        currentMonthExpense += t.amount;
                        const categoryName = categories.find(c => c.id === t.category)?.name || '未知類別';
                        monthlyCategoryExpenses[categoryName] = (monthlyCategoryExpenses[categoryName] || 0) + t.amount;
                    }
                }
            });

            currentMonthIncomeEl.textContent = formatCurrency(currentMonthIncome);
            currentMonthExpenseSummaryEl.textContent = formatCurrency(currentMonthExpense);
            currentMonthBalanceEl.textContent = formatCurrency(currentMonthIncome - currentMonthExpense);
            currentMonthBalanceEl.className = `font-bold ${currentMonthIncome - currentMonthExpense >= 0 ? 'text-blue-600' : 'text-red-600'}`;


            // Monthly Expense Breakdown by Category (List)
            monthlyCategoryBreakdownEl.innerHTML = '';
            const sortedMonthlyCategories = Object.keys(monthlyCategoryExpenses).sort((a, b) => monthlyCategoryExpenses[b] - monthlyCategoryExpenses[a]);

            if (sortedMonthlyCategories.length === 0) {
                noMonthlyBreakdownData.classList.remove('hidden');
            } else {
                noMonthlyBreakdownData.classList.add('hidden');
                sortedMonthlyCategories.forEach(categoryName => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-lg';
                    item.innerHTML = `
                        <span class="text-gray-700">${categoryName}</span>
                        <span class="font-medium text-red-600">${formatCurrency(monthlyCategoryExpenses[categoryName])}</span>
                    `;
                    monthlyCategoryBreakdownEl.appendChild(item);
                });
            }


            // Expense by Category Chart (Overall)
            const expenseData = {};
            transactions.filter(t => t.type === 'expense').forEach(t => {
                const categoryName = categories.find(c => c.id === t.category)?.name || '未知類別';
                expenseData[categoryName] = (expenseData[categoryName] || 0) + t.amount;
            });

            const expenseLabels = Object.keys(expenseData);
            const expenseValues = Object.values(expenseData);

            if (expenseValues.length === 0 || expenseValues.every(val => val === 0)) {
                noExpenseChartData.classList.remove('hidden');
                if (expenseByCategoryChart) {
                    expenseByCategoryChart.destroy();
                    expenseByCategoryChart = null;
                }
            } else {
                noExpenseChartData.classList.add('hidden');
                renderChart('expense-by-category-chart', 'pie', {
                    labels: expenseLabels,
                    datasets: [{
                        data: expenseValues,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40' // Repeat for more categories
                        ],
                        hoverOffset: 4
                    }]
                }, {});
            }


            // Monthly Income vs. Expense Chart
            const monthlyData = {}; // { 'YYYY-MM': { income: 0, expense: 0 } }
            transactions.forEach(t => {
                const monthYear = t.date.getFullYear() + '-' + String(t.date.getMonth() + 1).padStart(2, '0');
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = { income: 0, expense: 0 };
                }
                if (t.type === 'income') {
                    monthlyData[monthYear].income += t.amount;
                } else {
                    monthlyData[monthYear].expense += t.amount;
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const monthlyIncomeChartData = sortedMonths.map(month => monthlyData[month].income);
            const monthlyExpenseChartData = sortedMonths.map(month => monthlyData[month].expense);

            if (sortedMonths.length === 0) {
                noMonthlyChartData.classList.remove('hidden');
                if (monthlyIncomeExpenseChart) {
                    monthlyIncomeExpenseChart.destroy();
                    monthlyIncomeExpenseChart = null;
                }
            } else {
                noMonthlyChartData.classList.add('hidden');
                renderChart('monthly-income-expense-chart', 'bar', {
                    labels: sortedMonths,
                    datasets: [
                        {
                            label: '收入',
                            data: monthlyIncomeChartData,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '支出',
                            data: monthlyExpenseChartData,
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                }, {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                });
            }

            // Annual Summary
            const annualSummary = {}; // { 'YYYY': { income: 0, expense: 0, balance: 0 } }
            transactions.forEach(t => {
                const year = t.date.getFullYear();
                if (!annualSummary[year]) {
                    annualSummary[year] = { income: 0, expense: 0, balance: 0 };
                }
                if (t.type === 'income') {
                    annualSummary[year].income += t.amount;
                } else {
                    annualSummary[year].expense += t.amount;
                }
            });

            // Calculate balance for each year (cumulative)
            const sortedYears = Object.keys(annualSummary).sort();
            let cumulativeBalance = 0;
            annualSummaryEl.innerHTML = '';
            if (sortedYears.length === 0) {
                noAnnualSummary.classList.remove('hidden');
            } else {
                noAnnualSummary.classList.add('hidden');
                sortedYears.forEach(year => {
                    const data = annualSummary[year];
                    cumulativeBalance += (data.income - data.expense);
                    const yearDiv = document.createElement('div');
                    yearDiv.className = 'mb-4 p-3 bg-gray-50 rounded-lg shadow-sm';
                    yearDiv.innerHTML = `
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">${year} 年度</h4>
                        <p>總收入: <span class="text-green-600 font-medium">${formatCurrency(data.income)}</span></p>
                        <p>總支出: <span class="text-red-600 font-medium">${formatCurrency(data.expense)}</span></p>
                        <p>年度結餘: <span class="font-bold ${data.income - data.expense >= 0 ? 'text-blue-600' : 'text-red-600'}">${formatCurrency(data.income - data.expense)}</span></p>
                        <p>累計結餘: <span class="font-bold ${cumulativeBalance >= 0 ? 'text-blue-700' : 'text-red-700'}">${formatCurrency(cumulativeBalance)}</span></p>
                    `;
                    annualSummaryEl.appendChild(yearDiv);
                });
            }
        }

        /**
         * Renders a Chart.js chart.
         * @param {string} canvasId - The ID of the canvas element.
         * @param {string} type - Chart type (e.g., 'pie', 'bar', 'line').
         * @param {object} data - Chart data.
         * @param {object} options - Chart options.
         */
        function renderChart(canvasId, type, data, options) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            let chartInstance;

            if (canvasId === 'expense-by-category-chart') {
                if (expenseByCategoryChart) {
                    expenseByCategoryChart.destroy();
                }
                expenseByCategoryChart = new Chart(ctx, { type, data, options });
            } else if (canvasId === 'monthly-income-expense-chart') {
                if (monthlyIncomeExpenseChart) {
                    monthlyIncomeExpenseChart.destroy();
                }
                monthlyIncomeExpenseChart = new Chart(ctx, { type, data, options });
            }
        }

        // --- Data Export/Import Functions ---

        /**
         * Exports all transactions and categories to a JSON file.
         */
        async function exportDataToJson() {
            showLoading(true);
            try {
                const dataToExport = {
                    transactions: transactions.map(t => ({ // Convert Date objects back to string for export
                        ...t,
                        date: t.date.toISOString().split('T')[0] // YYYY-MM-DD format
                    })),
                    categories: categories
                };
                const jsonString = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `finance_data_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showModal("資料匯出成功！", 'alert');
            } catch (error) {
                console.error("Error exporting data:", error);
                showModal("匯出資料失敗。", 'alert');
            } finally {
                showLoading(false);
            }
        }

        /**
         * Imports data from a selected JSON file.
         */
        async function importDataFromJson(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            showModal("匯入資料將會覆蓋您現有的所有記帳資料。您確定要繼續嗎？", 'confirm', async (confirmed) => {
                if (confirmed) {
                    showLoading(true);
                    try {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            try {
                                const importedData = JSON.parse(e.target.result);
                                if (importedData.transactions && Array.isArray(importedData.transactions) &&
                                    importedData.categories && Array.isArray(importedData.categories)) {

                                    // Clear existing data in IndexedDB
                                    await clearObjectStore('transactions');
                                    await clearObjectStore('categories');

                                    // Add imported categories
                                    for (const cat of importedData.categories) {
                                        await saveToIndexedDB('categories', cat);
                                    }
                                    // Add imported transactions
                                    for (const trans of importedData.transactions) {
                                        await saveToIndexedDB('transactions', trans);
                                    }

                                    showModal("資料匯入成功！", 'alert');
                                    await loadCategories(); // Reload categories and transactions
                                    await loadTransactions();
                                    displayView('dashboard-view'); // Go back to dashboard
                                } else {
                                    showModal("匯入的檔案格式不正確。請確保它包含 'transactions' 和 'categories' 陣列。", 'alert');
                                }
                            } catch (parseError) {
                                console.error("Error parsing imported JSON:", parseError);
                                showModal("解析匯入檔案失敗。請確保它是有效的 JSON 格式。", 'alert');
                            } finally {
                                showLoading(false);
                            }
                        };
                        reader.readAsText(file);
                    } catch (error) {
                        console.error("Error reading import file:", error);
                        showModal("讀取匯入檔案失敗。", 'alert');
                        showLoading(false);
                    }
                }
            });
            // Clear the file input value to allow re-importing the same file
            event.target.value = '';
        }

        // --- Event Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            // Set default date to today for new transactions
            transactionDateEl.valueAsDate = new Date();

            // Initialize the app directly
            initApp();

            // Navigation
            document.querySelectorAll('.nav-item').forEach(button => {
                button.addEventListener('click', (e) => {
                    displayView(e.currentTarget.dataset.view);
                });
            });

            // Add Transaction Form Submission
            transactionForm.addEventListener('submit', addTransaction);

            // Add Category Form Submission
            addCategoryForm.addEventListener('submit', addCategory);

            // Filter and Sort Listeners for Transactions List
            filterDescriptionEl.addEventListener('input', renderAllTransactions);
            filterCategoryEl.addEventListener('change', renderAllTransactions);
            sortOrderEl.addEventListener('change', renderAllTransactions);

            // Export/Import Buttons
            exportDataBtn.addEventListener('click', exportDataToJson);
            importDataBtn.addEventListener('click', () => importFileInput.click()); // Trigger hidden file input click
            importFileInput.addEventListener('change', importDataFromJson);

            // Ensure the app container adjusts its height for mobile responsiveness
            window.addEventListener('resize', () => {
                const viewportHeight = window.innerHeight;
                appContainer.style.minHeight = `${viewportHeight * 0.8}px`; // 80% of viewport height
            });
            window.dispatchEvent(new Event('resize')); // Trigger on load
        });
    </script>
</body>
</html>
